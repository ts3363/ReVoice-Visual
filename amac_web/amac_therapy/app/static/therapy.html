<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMAC Speech Therapy Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --sidebar-width: 250px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 20px;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .nav-link {
            padding: 15px 20px;
            border-left: 4px solid transparent;
            color: #333;
            transition: all 0.3s;
        }
        
        .nav-link:hover {
            background: #f0f5ff;
            color: var(--primary-color);
        }
        
        .nav-link.active {
            background: #f0f5ff;
            color: var(--primary-color);
            border-left-color: var(--primary-color);
            font-weight: 600;
        }
        
        .nav-link i {
            width: 24px;
            text-align: center;
            margin-right: 10px;
        }
        
        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px;
        }
        
        .page {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cards */
        .dashboard-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            padding: 25px;
            margin-bottom: 25px;
            transition: transform 0.3s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        /* Stats Cards */
        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        /* Progress Rings */
        .progress-ring {
            width: 120px;
            height: 120px;
        }
        
        /* Exercise Cards */
        .exercise-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid var(--primary-color);
        }
        
        /* Feedback Bubbles */
        .feedback-bubble {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid var(--success-color);
        }
        
        /* Session Controls */
        .session-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4><i class="fas fa-comment-medical"></i> AMAC Therapy</h4>
            <p class="mb-0">Speech Improvement System</p>
        </div>
        
        <nav class="nav flex-column mt-4">
            <a class="nav-link active" href="#" onclick="showPage('dashboard')">
                <i class="fas fa-home"></i> Dashboard
            </a>
            <a class="nav-link" href="#" onclick="showPage('therapy')">
                <i class="fas fa-microphone-alt"></i> Therapy Session
            </a>
            <a class="nav-link" href="#" onclick="showPage('progress')">
                <i class="fas fa-chart-line"></i> Progress & Charts
            </a>
            <a class="nav-link" href="#" onclick="showPage('feedback')">
                <i class="fas fa-comment-dots"></i> Overall Feedback
            </a>
            <a class="nav-link" href="#" onclick="showPage('help')">
                <i class="fas fa-question-circle"></i> Help & Support
            </a>
        </nav>
        
        <div class="mt-auto p-3">
            <div class="text-center">
                <div class="mb-3">
                    <i class="fas fa-user-circle fa-3x text-primary"></i>
                </div>
                <h6 id="sidebarUserName">Test User</h6>
                <small class="text-muted" id="sidebarUserLevel">Moderate Dysarthria</small>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Page 1: Dashboard -->
        <div id="dashboard" class="page active">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h1>
                <button class="btn btn-success" onclick="startSession()">
                    <i class="fas fa-play me-2"></i>Start New Session
                </button>
            </div>
            
            <!-- Stats Row -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <i class="fas fa-calendar-alt fa-2x"></i>
                        <div class="stat-number" id="totalSessions">5</div>
                        <small>Total Sessions</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #4cc9f0, #4361ee);">
                        <i class="fas fa-trophy fa-2x"></i>
                        <div class="stat-number" id="bestScore">85</div>
                        <small>Best Score</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #f72585, #ff6b6b);">
                        <i class="fas fa-fire fa-2x"></i>
                        <div class="stat-number" id="dayStreak">3</div>
                        <small>Day Streak</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #38b000, #70e000);">
                        <i class="fas fa-chart-line fa-2x"></i>
                        <div class="stat-number" id="avgScore">72</div>
                        <small>Avg Score</small>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity & Quick Start -->
            <div class="row">
                <div class="col-md-8">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-history me-2"></i>Recent Activity</h4>
                        <div id="recentActivity">
                            <div class="text-center p-3 text-muted" id="noActivityMessage">
                                <i class="fas fa-clock fa-2x mb-3"></i>
                                <p>No recent activity. Complete exercises to see your progress!</p>
                            </div>
                        </div>
                        <div class="mt-3" id="viewAllExercisesBtn" style="display: none;">
                            <button class="btn btn-outline-primary w-100" onclick="showExerciseHistory()">
                                <i class="fas fa-list me-2"></i>View All Completed Exercises
                            </button>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-bullseye me-2"></i>Today's Goals</h4>
                        <div id="todaysGoals">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="goal1" checked>
                                <label class="form-check-label" for="goal1">
                                    Complete 1 therapy session
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="goal2">
                                <label class="form-check-label" for="goal2">
                                    Achieve 75+ clarity score
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="goal3">
                                <label class="form-check-label" for="goal3">
                                    Practice for 15 minutes
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-user me-2"></i>Patient Profile</h4>
                        <div class="text-center mt-4">
                            <div class="mb-3">
                                <i class="fas fa-user-circle fa-5x text-primary"></i>
                            </div>
                            <h4 id="userName">Test User</h4>
                            <div class="badge bg-info mb-3" id="impairmentLevel">Moderate Dysarthria</div>
                            
                            <div class="text-start">
                                <p><strong><i class="fas fa-calendar me-2"></i>Member Since:</strong> Jan 2024</p>
                                <p><strong><i class="fas fa-star me-2"></i>Current Level:</strong> Intermediate</p>
                                <p><strong><i class="fas fa-bullseye me-2"></i>Next Milestone:</strong> 10 Sessions</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-lightbulb me-2"></i>Quick Tips</h4>
                        <div class="mt-3">
                            <div class="feedback-bubble">
                                <i class="fas fa-volume-up me-2"></i>
                                <strong>Speak slowly</strong> - Pace improves clarity
                            </div>
                            <div class="feedback-bubble">
                                <i class="fas fa-wind me-2"></i>
                                <strong>Use breath support</strong> - Take deep breaths
                            </div>
                            <div class="feedback-bubble">
                                <i class="fas fa-stopwatch me-2"></i>
                                <strong>Practice daily</strong> - Consistency is key
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 2: Therapy Session -->
        <div id="therapy" class="page">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-microphone-alt me-2"></i>Therapy Session</h1>
                <div>
                    <span class="badge bg-primary fs-6" id="sessionStatus">Ready to Start</span>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-tasks me-2"></i>Current Exercise</h4>
                        <div id="currentExercise" class="text-center p-5">
                            <i class="fas fa-play-circle fa-4x text-primary mb-3"></i>
                            <h3>Ready to Start Therapy</h3>
                            <p class="text-muted">Click "Start Session" to begin your speech exercises</p>
                            <button class="btn btn-success btn-lg mt-3" onclick="startTherapySession()">
                                <i class="fas fa-play me-2"></i>Start Session
                            </button>
                        </div>
                        
                        <!-- Progress Indicator -->
                        <div class="mt-4" id="progressIndicator" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small>Session Progress</small>
                                <small id="progressText">0/0 exercises</small>
                            </div>
                            <div class="progress" style="height: 10px;">
                                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Session Controls -->
                        <div class="mt-4 text-center" id="sessionControls" style="display: none;">
                            <button id="recordBtn" class="btn btn-primary btn-lg me-3" onclick="recordAttempt()">
                                <i class="fas fa-microphone me-2"></i>Record Attempt
                            </button>
                            <button id="skipBtn" class="btn btn-outline-secondary me-3" onclick="skipExercise()">
                                <i class="fas fa-forward me-2"></i>Skip Exercise
                            </button>
                            <button id="nextExerciseBtn" class="btn btn-success btn-lg" onclick="loadNextExercise()" style="display: none;">
                                <i class="fas fa-arrow-right me-2"></i>Next Exercise
                            </button>
                        </div>
                    </div>
                    
                    <!-- Real-time Feedback -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-comment-dots me-2"></i>Real-time Feedback</h4>
                        <div id="feedbackContainer" class="mt-3">
                            <div class="text-center p-4 text-muted">
                                <i class="fas fa-info-circle fa-2x mb-3"></i>
                                <p>Complete exercises to receive personalized feedback</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <!-- Camera Preview -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-video me-2"></i>Camera Preview</h4>
                        <div class="mt-3">
                            <div class="video-container">
                                <video id="videoPreview" autoplay muted playsinline 
                                       class="rounded shadow w-100"></video>
                                <div class="text-center mt-2">
                                    <small class="text-muted" id="cameraStatus">Camera ready</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Exercises -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-history me-2"></i>Recent Exercises</h4>
                        <div id="recentExercises" class="mt-3">
                            <div class="text-center text-muted p-3">
                                <i class="fas fa-clock fa-2x mb-3"></i>
                                <p>No exercises completed yet</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-bar me-2"></i>Session Stats</h4>
                        <div class="row text-center mt-3">
                            <div class="col-6">
                                <div class="p-2">
                                    <div class="h3 fw-bold" id="sessionScore">0</div>
                                    <small>Current Score</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2">
                                    <div class="h3 fw-bold" id="exercisesDone">0</div>
                                    <small>Exercises Done</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Progress & Charts -->
        <div id="progress" class="page">
            <h1 class="mb-4"><i class="fas fa-chart-line me-2"></i>Progress & Charts</h1>
            
            <div class="row">
                <div class="col-md-8">
                    <!-- Progress Chart -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-area me-2"></i>Progress Over Time</h4>
                        <div class="mt-3">
                            <canvas id="progressChart" height="250"></canvas>
                        </div>
                    </div>
                    
                    <!-- Monthly Performance -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-calendar-alt me-2"></i>Monthly Performance</h4>
                        <div class="mt-3">
                            <canvas id="monthlyChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <!-- Statistics -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-pie me-2"></i>Statistics</h4>
                        <div class="mt-4">
                            <div class="mb-3">
                                <small>Overall Improvement</small>
                                <div class="progress" style="height: 15px;">
                                    <div class="progress-bar bg-success" style="width: 65%">65%</div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <small>Consistency Score</small>
                                <div class="progress" style="height: 15px;">
                                    <div class="progress-bar bg-info" style="width: 78%">78%</div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <small>Articulation Accuracy</small>
                                <div class="progress" style="height: 15px;">
                                    <div class="progress-bar bg-warning" style="width: 72%">72%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Milestones -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-trophy me-2"></i>Milestones</h4>
                        <div id="milestonesList" class="mt-3">
                            <div class="feedback-bubble">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <strong>First Session</strong> - Completed
                            </div>
                            <div class="feedback-bubble">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <strong>5 Sessions</strong> - Completed
                            </div>
                            <div class="feedback-bubble">
                                <i class="fas fa-star text-warning me-2"></i>
                                <strong>70+ Score</strong> - Achieved
                            </div>
                            <div class="feedback-bubble">
                                <i class="fas fa-clock text-muted me-2"></i>
                                <strong>10 Sessions</strong> - 5/10
                                <div class="progress mt-2" style="height: 5px;">
                                    <div class="progress-bar" style="width: 50%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export Options -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-download me-2"></i>Export Progress</h4>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-file-pdf me-2"></i>Download PDF Report
                            </button>
                            <button class="btn btn-outline-secondary w-100">
                                <i class="fas fa-chart-bar me-2"></i>Export Data (CSV)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 4: Overall Feedback -->
        <div id="feedback" class="page">
            <h1 class="mb-4"><i class="fas fa-comment-dots me-2"></i>Overall Feedback</h1>
            
            <div class="row">
                <div class="col-md-8">
                    <!-- Comprehensive Feedback -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-star me-2"></i>Performance Summary</h4>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="text-center p-3">
                                    <h5>Clarity Score</h5>
                                    <div class="position-relative d-inline-block mt-3">
                                        <svg class="progress-ring" id="overallClarityRing">
                                            <circle class="progress-ring-circle" stroke="#e9ecef" stroke-width="8" 
                                                    fill="transparent" r="52" cx="60" cy="60"/>
                                            <circle class="progress-ring-circle" stroke="#4361ee" stroke-width="8" 
                                                    fill="transparent" r="52" cx="60" cy="60" 
                                                    stroke-dasharray="326.56" stroke-dashoffset="98"/>
                                        </svg>
                                        <div class="position-absolute top-50 start-50 translate-middle">
                                            <span class="display-4 fw-bold">72</span>
                                            <span class="fs-6">/100</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>Strengths</h5>
                                <div class="mt-3">
                                    <div class="feedback-bubble" style="background: #d4edda; border-color: #28a745;">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <strong>Vowel Sounds</strong> - Excellent clarity
                                    </div>
                                    <div class="feedback-bubble" style="background: #d4edda; border-color: #28a745;">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <strong>Pacing</strong> - Good speech rate
                                    </div>
                                    <div class="feedback-bubble" style="background: #d4edda; border-color: #28a745;">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <strong>Consistency</strong> - Regular practice
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Areas for Improvement -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-bullseye me-2"></i>Areas for Improvement</h4>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="exercise-card">
                                    <h6><i class="fas fa-exclamation-triangle text-warning me-2"></i>Sibilant Sounds</h6>
                                    <p>Work on "S", "SH", "Z" sounds</p>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-warning" style="width: 65%"></div>
                                    </div>
                                    <small class="text-muted">Current: 65% accuracy</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="exercise-card">
                                    <h6><i class="fas fa-exclamation-triangle text-warning me-2"></i>Consonant Clusters</h6>
                                    <p>Practice "STR", "SPL", "THR" combinations</p>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-warning" style="width: 58%"></div>
                                    </div>
                                    <small class="text-muted">Current: 58% accuracy</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Therapist Notes -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-sticky-note me-2"></i>Therapist Notes</h4>
                        <div class="mt-3">
                            <div class="feedback-bubble">
                                <i class="fas fa-user-md text-primary me-2"></i>
                                <strong>Dr. Smith, Speech Therapist:</strong>
                                <p class="mt-2 mb-0">"Great progress with vowel sounds. Focus on consonant endings and breath support for longer sentences. Practice daily for 15 minutes."</p>
                                <small class="text-muted">Last updated: 2 days ago</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <!-- Recommendations -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-lightbulb me-2"></i>Recommendations</h4>
                        <div class="mt-3">
                            <div class="feedback-bubble">
                                <i class="fas fa-dumbbell me-2"></i>
                                <strong>Daily Exercises:</strong>
                                <ul class="mt-2 mb-0">
                                    <li>5 minutes of "S" sound practice</li>
                                    <li>10 minutes of sentence reading</li>
                                    <li>5 minutes of breathing exercises</li>
                                </ul>
                            </div>
                            <div class="feedback-bubble">
                                <i class="fas fa-calendar-check me-2"></i>
                                <strong>Schedule:</strong>
                                <p class="mt-2 mb-0">Morning: 10 AM - Best time for practice<br>Evening: Review progress</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Timeline -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-history me-2"></i>Progress Timeline</h4>
                        <div class="mt-3">
                            <div class="timeline">
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-success"></div>
                                    <div class="timeline-content">
                                        <small>Today</small>
                                        <p class="mb-0">Score: 78/100</p>
                                    </div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-success"></div>
                                    <div class="timeline-content">
                                        <small>Yesterday</small>
                                        <p class="mb-0">Score: 72/100</p>
                                    </div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-warning"></div>
                                    <div class="timeline-content">
                                        <small>2 days ago</small>
                                        <p class="mb-0">Score: 68/100</p>
                                    </div>
                                </div>
                                <style>
                                    .timeline {
                                        position: relative;
                                        padding-left: 30px;
                                    }
                                    .timeline-item {
                                        position: relative;
                                        margin-bottom: 20px;
                                    }
                                    .timeline-marker {
                                        position: absolute;
                                        left: -30px;
                                        top: 5px;
                                        width: 15px;
                                        height: 15px;
                                        border-radius: 50%;
                                    }
                                    .timeline-content {
                                        padding-bottom: 10px;
                                        border-bottom: 1px solid #eee;
                                    }
                                </style>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 5: Help & Support -->
        <div id="help" class="page">
            <h1 class="mb-4"><i class="fas fa-question-circle me-2"></i>Help & Support</h1>
            
            <div class="row">
                <div class="col-md-8">
                    <!-- FAQ -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-question me-2"></i>Frequently Asked Questions</h4>
                        <div class="accordion mt-3" id="faqAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                        How do I start a therapy session?
                                    </button>
                                </h2>
                                <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                                    <div class="accordion-body">
                                        Go to the <strong>Therapy Session</strong> page and click "Start Session". Make sure your microphone and camera are enabled.
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                        How is my score calculated?
                                    </button>
                                </h2>
                                <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                    <div class="accordion-body">
                                        Your score is based on speech clarity, articulation accuracy, pacing, and volume consistency. The system uses AI to analyze your speech patterns.
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                        How often should I practice?
                                    </button>
                                </h2>
                                <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                    <div class="accordion-body">
                                        For best results, practice daily for 15-20 minutes. Consistency is more important than long sessions.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Troubleshooting -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-tools me-2"></i>Troubleshooting</h4>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="exercise-card">
                                    <h6><i class="fas fa-microphone-slash text-danger me-2"></i>Microphone Issues</h6>
                                    <p>Check browser permissions and ensure microphone is not muted.</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="exercise-card">
                                    <h6><i class="fas fa-video-slash text-danger me-2"></i>Camera Issues</h6>
                                    <p>Allow camera access in browser settings and ensure good lighting.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <!-- Contact Support -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-headset me-2"></i>Contact Support</h4>
                        <div class="mt-3">
                            <div class="feedback-bubble">
                                <i class="fas fa-envelope me-2"></i>
                                <strong>Email:</strong> support@amac-therapy.com
                            </div>
                            <div class="feedback-bubble">
                                <i class="fas fa-phone me-2"></i>
                                <strong>Phone:</strong> 1-800-AMAC-HELP
                            </div>
                            <div class="feedback-bubble">
                                <i class="fas fa-clock me-2"></i>
                                <strong>Hours:</strong> Mon-Fri, 9 AM - 5 PM
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Links -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-link me-2"></i>Quick Links</h4>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-book me-2"></i>User Guide
                            </button>
                            <button class="btn btn-outline-secondary w-100 mb-2">
                                <i class="fas fa-video me-2"></i>Video Tutorials
                            </button>
                            <button class="btn btn-outline-success w-100">
                                <i class="fas fa-file-download me-2"></i>Download Resources
                            </button>
                        </div>
                    </div>
                    
                    <!-- System Status -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-server me-2"></i>System Status</h4>
                        <div class="mt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Speech Recognition</span>
                                <span class="badge bg-success">Online</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>AI Analysis</span>
                                <span class="badge bg-success">Online</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Progress Tracking</span>
                                <span class="badge bg-success">Online</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Database</span>
                                <span class="badge bg-success">Online</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Controls (Floating) -->
    <div class="session-controls">
        <div class="btn-group" role="group">
            <button class="btn btn-primary" onclick="showPage('therapy')">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="btn btn-success" onclick="showPage('progress')">
                <i class="fas fa-chart-line"></i>
            </button>
            <button class="btn btn-info" onclick="showPage('feedback')">
                <i class="fas fa-comment"></i>
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentSession = null;
        let currentExercise = null;
        let sessionExercises = [];
        let completedExercises = [];
        let progressChart = null;
        let monthlyChart = null;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('AMAC Dashboard Initializing...');
            
            // Load saved exercises from localStorage
            loadSavedExercises();
            
            // Setup camera
            await setupCamera();
            
            // Load user profile
            await loadUserProfile();
            
            // Load completed sessions from API
            await loadCompletedSessions();
            
            // Initialize charts
            initializeCharts();
            
            console.log('Dashboard Ready!');
        });
        
        // Save completed exercises to localStorage
        function saveCompletedExercises() {
            const username = localStorage.getItem('amacUsername') || sessionStorage.getItem('amacUsername') || 'default';
            const key = `amac_exercises_${username}`;
            try {
                localStorage.setItem(key, JSON.stringify({
                    exercises: completedExercises,
                    lastUpdated: new Date().toISOString()
                }));
            } catch (error) {
                console.error('Error saving exercises:', error);
            }
        }
        
        // Load saved exercises from localStorage
        function loadSavedExercises() {
            const username = localStorage.getItem('amacUsername') || sessionStorage.getItem('amacUsername') || 'default';
            const key = `amac_exercises_${username}`;
            try {
                const saved = localStorage.getItem(key);
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.exercises && Array.isArray(data.exercises)) {
                        completedExercises = data.exercises;
                        console.log('Loaded', completedExercises.length, 'saved exercises');
                    }
                }
            } catch (error) {
                console.error('Error loading exercises:', error);
            }
        }
        
        // Load completed sessions from API
        async function loadCompletedSessions() {
            try {
                const username = localStorage.getItem('amacUsername') || sessionStorage.getItem('amacUsername') || 'test_user';
                const response = await fetch(`/api/therapy/sessions?user_id=${encodeURIComponent(username)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.sessions && data.sessions.length > 0) {
                        // Update recent activity with API data
                        updateRecentActivityFromAPI(data.sessions);
                    }
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }
        
        // Update recent activity section with API data
        function updateRecentActivityFromAPI(sessions) {
            const recentActivityDiv = document.getElementById('recentActivity');
            if (!recentActivityDiv) return;
            
            let html = '';
            const recentSessions = sessions.slice(-5).reverse(); // Last 5 sessions
            
            recentSessions.forEach(session => {
                const sessionDate = new Date(session.date);
                const dateStr = sessionDate.toLocaleDateString();
                const isToday = sessionDate.toDateString() === new Date().toDateString();
                const dateLabel = isToday ? 'Today' : dateStr;
                
                html += `
                    <div class="exercise-card">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>Session: ${dateLabel}</strong>
                                <p class="mb-1">Completed ${session.exercises_completed} exercises</p>
                                <small class="text-muted">Avg Score: ${session.average_score.toFixed(1)}/100</small>
                            </div>
                            <span class="badge bg-success">Completed</span>
                        </div>
                    </div>
                `;
            });
            
            if (html) {
                recentActivityDiv.innerHTML = html;
            }
        }
        
        // Page navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Special handling for each page
            if (pageId === 'progress') {
                updateProgressCharts();
            }
        }
        
        // Setup camera
        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 320, height: 240 },
                    audio: true
                });
                
                document.getElementById('videoPreview').srcObject = stream;
                document.getElementById('cameraStatus').textContent = 'Camera active';
                
            } catch (err) {
                console.error('Camera error:', err);
                document.getElementById('cameraStatus').textContent = 'Camera access needed';
                document.getElementById('cameraStatus').className = 'text-danger';
            }
        }
        
        // Load user profile
        async function loadUserProfile() {
            try {
                const username = localStorage.getItem('amacUsername') || sessionStorage.getItem('amacUsername') || 'test_user';
                const response = await fetch(`/api/user/profile?username=${encodeURIComponent(username)}`);
                const data = await response.json();
                
                // Update dashboard
                document.getElementById('userName').textContent = data.name || 'Patient';
                document.getElementById('sidebarUserName').textContent = data.name || 'Patient';
                document.getElementById('impairmentLevel').textContent = data.impairment_level || 'Moderate';
                document.getElementById('sidebarUserLevel').textContent = data.impairment_level || 'Moderate';
                document.getElementById('totalSessions').textContent = data.total_sessions || 0;
                document.getElementById('dayStreak').textContent = data.day_streak || 0;
                
                // Load progress data
                const progressResponse = await fetch(`/api/user/progress?username=${encodeURIComponent(username)}`);
                if (progressResponse.ok) {
                    const progressData = await progressResponse.json();
                    document.getElementById('bestScore').textContent = progressData.best_score || 0;
                    document.getElementById('avgScore').textContent = Math.round(progressData.average_clarity || 0);
                }
                
                // Update recent activity with saved exercises
                updateRecentActivityFromSavedExercises();
                
            } catch (error) {
                console.error('Profile error:', error);
            }
        }
        
        // Update recent activity with saved exercises
        function updateRecentActivityFromSavedExercises() {
            if (completedExercises.length === 0) return;
            
            // Group exercises by date
            const exercisesByDate = {};
            completedExercises.forEach(ex => {
                const date = new Date(ex.date || ex.timestamp);
                const dateKey = date.toDateString();
                if (!exercisesByDate[dateKey]) {
                    exercisesByDate[dateKey] = {
                        date: date,
                        exercises: [],
                        totalScore: 0
                    };
                }
                exercisesByDate[dateKey].exercises.push(ex);
                exercisesByDate[dateKey].totalScore += ex.score;
            });
            
            // Convert to array and sort by date
            const sessions = Object.values(exercisesByDate).map(group => ({
                date: group.date,
                exercises_completed: group.exercises.length,
                average_score: group.totalScore / group.exercises.length
            })).sort((a, b) => b.date - a.date).slice(0, 5);
            
            if (sessions.length > 0) {
                updateRecentActivityDisplay(sessions);
            }
        }
        
        // Update recent activity display
        function updateRecentActivityDisplay(sessions) {
            const recentActivityDiv = document.getElementById('recentActivity');
            const noActivityMsg = document.getElementById('noActivityMessage');
            const viewAllBtn = document.getElementById('viewAllExercisesBtn');
            
            if (!recentActivityDiv) return;
            
            if (sessions.length === 0) {
                if (noActivityMsg) noActivityMsg.style.display = 'block';
                if (viewAllBtn) viewAllBtn.style.display = 'none';
                return;
            }
            
            if (noActivityMsg) noActivityMsg.style.display = 'none';
            if (viewAllBtn) viewAllBtn.style.display = 'block';
            
            let html = '';
            sessions.forEach(session => {
                const sessionDate = session.date;
                const dateStr = sessionDate.toLocaleDateString();
                const isToday = sessionDate.toDateString() === new Date().toDateString();
                const isYesterday = sessionDate.toDateString() === new Date(Date.now() - 86400000).toDateString();
                const dateLabel = isToday ? 'Today' : isYesterday ? 'Yesterday' : dateStr;
                
                html += `
                    <div class="exercise-card">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>Session: ${dateLabel}</strong>
                                <p class="mb-1">Completed ${session.exercises_completed} exercises</p>
                                <small class="text-muted">Avg Score: ${session.average_score.toFixed(1)}/100</small>
                            </div>
                            <span class="badge bg-success">Completed</span>
                        </div>
                    </div>
                `;
            });
            
            recentActivityDiv.innerHTML = html;
        }
        
        // Show exercise history modal/page
        function showExerciseHistory() {
            // Create or show exercise history
            const historyHtml = `
                <div class="dashboard-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-list me-2"></i>Exercise History</h4>
                        <button class="btn btn-sm btn-outline-secondary" onclick="closeExerciseHistory()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="exerciseHistoryList" class="mt-3">
                        ${renderExerciseHistory()}
                    </div>
                </div>
            `;
            
            // If on therapy page, switch to dashboard to show history
            const dashboardPage = document.getElementById('dashboard');
            if (dashboardPage && !dashboardPage.classList.contains('active')) {
                showPage('dashboard');
            }
            
            // Insert history into a new section or modal
            let historySection = document.getElementById('exerciseHistorySection');
            if (!historySection) {
                historySection = document.createElement('div');
                historySection.id = 'exerciseHistorySection';
                historySection.innerHTML = historyHtml;
                const dashboardContent = document.getElementById('dashboard');
                if (dashboardContent) {
                    dashboardContent.appendChild(historySection);
                }
            } else {
                historySection.innerHTML = historyHtml;
                historySection.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // Render exercise history
        function renderExerciseHistory() {
            if (completedExercises.length === 0) {
                return '<div class="text-center p-4 text-muted"><p>No exercises completed yet.</p></div>';
            }
            
            // Group by date
            const exercisesByDate = {};
            completedExercises.forEach(ex => {
                const date = new Date(ex.date || ex.timestamp);
                const dateKey = date.toDateString();
                if (!exercisesByDate[dateKey]) {
                    exercisesByDate[dateKey] = [];
                }
                exercisesByDate[dateKey].push(ex);
            });
            
            let html = '';
            const sortedDates = Object.keys(exercisesByDate).sort((a, b) => 
                new Date(b) - new Date(a)
            );
            
            sortedDates.forEach(dateKey => {
                const date = new Date(dateKey);
                const exercises = exercisesByDate[dateKey];
                const avgScore = exercises.reduce((sum, ex) => sum + ex.score, 0) / exercises.length;
                
                html += `
                    <div class="exercise-card mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5><i class="fas fa-calendar me-2"></i>${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h5>
                            <span class="badge bg-primary">${exercises.length} exercises • Avg: ${avgScore.toFixed(1)}</span>
                        </div>
                        <div class="list-group">
                `;
                
                exercises.forEach((ex, idx) => {
                    const scoreColor = ex.score >= 80 ? 'success' : ex.score >= 60 ? 'warning' : 'danger';
                    const time = new Date(ex.date || ex.timestamp).toLocaleTimeString();
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${ex.exercise.target}</strong>
                                    <br>
                                    <small class="text-muted">
                                        ${ex.exercise.type} • ${ex.exercise.instructions}
                                    </small>
                                    <br>
                                    <small class="text-muted">${time}</small>
                                </div>
                                <span class="badge bg-${scoreColor} fs-6">${ex.score}/100</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        // Close exercise history
        function closeExerciseHistory() {
            const historySection = document.getElementById('exerciseHistorySection');
            if (historySection) {
                historySection.remove();
            }
        }
        
        // Start therapy session (from dashboard)
        function startSession() {
            showPage('therapy');
            startTherapySession();
        }
        
        // Start therapy session (from therapy page)
        async function startTherapySession() {
            try {
                // Get current username from storage
                const username = localStorage.getItem('amacUsername') || sessionStorage.getItem('amacUsername') || 'test_user';
                
                const response = await fetch('/api/therapy/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: username })
                });
                
                const data = await response.json();
                currentSession = data.session_id;
                sessionExercises = data.total_exercises || 4;
                
                // Update UI
                document.getElementById('sessionStatus').textContent = 'Session Active';
                document.getElementById('sessionStatus').className = 'badge bg-success fs-6';
                
                document.getElementById('currentExercise').innerHTML = `
                    <h3>Session Started!</h3>
                    <p>Loading first exercise...</p>
                `;
                
                document.getElementById('progressIndicator').style.display = 'block';
                document.getElementById('sessionControls').style.display = 'block';
                
                // Reset exercise counters
                completedExercises = [];
                
                // Load first exercise from API
                if (data.first_exercise) {
                    currentExercise = {
                        exercise_number: 1,
                        total_exercises: data.total_exercises,
                        ...data.first_exercise
                    };
                    setTimeout(() => {
                        displayCurrentExercise();
                        updateProgressIndicator();
                    }, 1000);
                } else {
                    // Fallback to sample exercise
                    setTimeout(() => {
                        loadSampleExercise();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Session error:', error);
                alert('Failed to start session. Please try again.');
            }
        }
        
        // Load sample exercise (for demo)
        function loadSampleExercise() {
            const exercises = [
                {
                    target: "AH",
                    instructions: "Say 'AH' with open mouth, hold for 3 seconds",
                    type: "phoneme",
                    difficulty: 1
                },
                {
                    target: "EE",
                    instructions: "Smile wide, say 'EE' clearly",
                    type: "phoneme",
                    difficulty: 1
                },
                {
                    target: "Hello",
                    instructions: "Say 'Hello' clearly with good breath support",
                    type: "word", 
                    difficulty: 2
                },
                {
                    target: "Good morning",
                    instructions: "Greet naturally with clear pronunciation",
                    type: "sentence",
                    difficulty: 3
                },
                {
                    target: "The sun is bright",
                    instructions: "Read this sentence with clear 'S' and 'T' sounds",
                    type: "sentence",
                    difficulty: 3
                }
            ];
            
            const randomExercise = exercises[Math.floor(Math.random() * exercises.length)];
            
            currentExercise = {
                exercise_number: completedExercises.length + 1,
                total_exercises: sessionExercises || 4,
                ...randomExercise
            };
            
            displayCurrentExercise();
            updateProgressIndicator();
        }
        
        // Display current exercise
        function displayCurrentExercise() {
            if (!currentExercise) return;
            
            document.getElementById('currentExercise').innerHTML = `
                <div class="text-center">
                    <div class="badge bg-primary mb-2">
                        Exercise ${currentExercise.exercise_number}/${currentExercise.total_exercises}
                    </div>
                    <h2 class="display-4 text-primary mb-3">${currentExercise.target}</h2>
                    <p class="lead">${currentExercise.instructions}</p>
                    
                    <div class="alert alert-secondary mt-3">
                        <i class="fas fa-lightbulb"></i> <strong>Tip:</strong> 
                        ${currentExercise.type === 'phoneme' ? 'Hold the sound steady' : 
                          currentExercise.type === 'word' ? 'Break into syllables' : 
                          'Pause between words'}
                    </div>
                </div>
            `;
        }
        
        // Update progress indicator
        function updateProgressIndicator() {
            if (!currentExercise) return;
            
            const progress = ((currentExercise.exercise_number - 1) / currentExercise.total_exercises) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = 
                `${currentExercise.exercise_number - 1}/${currentExercise.total_exercises} exercises`;
        }
        
        // Record attempt
        async function recordAttempt() {
            // Show recording
            const recordBtn = document.getElementById('recordBtn');
            recordBtn.innerHTML = '<i class="fas fa-circle"></i> Recording...';
            recordBtn.disabled = true;
            
            let score = 0;
            
            // Try to use API if session exists
            if (currentSession && currentExercise) {
                try {
                    const response = await fetch('/api/therapy/process-attempt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: currentSession,
                            exercise_id: currentExercise.id || currentExercise.exercise_number,
                            audio_data: 'demo_audio_data' // In real implementation, send actual audio
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.result) {
                        score = data.result.score || (60 + Math.floor(Math.random() * 35));
                        
                        // Update current session if API returns next exercise
                        if (data.next_exercise) {
                            // There's a next exercise available
                        } else if (data.session_summary) {
                            // Session is complete
                        }
                    } else {
                        // Fallback to random score
                        score = 60 + Math.floor(Math.random() * 35);
                    }
                } catch (error) {
                    console.error('Error processing attempt:', error);
                    // Fallback to random score
                    score = 60 + Math.floor(Math.random() * 35);
                }
            } else {
                // Simulate processing for demo
                score = 60 + Math.floor(Math.random() * 35);
            }
            
            // Simulate processing delay
            setTimeout(() => {
                // Store completed exercise
                const completedExercise = {
                    exercise: currentExercise,
                    score: score,
                    timestamp: new Date().toLocaleTimeString(),
                    date: new Date().toISOString(),
                    session_id: currentSession || 'local_session'
                };
                
                completedExercises.push(completedExercise);
                
                // Save to localStorage for persistence
                saveCompletedExercises();
                
                // Update stats
                updateSessionStats(score);
                
                // Show feedback
                showExerciseFeedback(score);
                
                // Update recent exercises
                updateRecentExercises();
                
                // Reset button
                recordBtn.innerHTML = '<i class="fas fa-microphone me-2"></i>Record Attempt';
                recordBtn.disabled = false;
                
                // Hide record and skip buttons, show Next Exercise button
                recordBtn.style.display = 'none';
                document.getElementById('skipBtn').style.display = 'none';
                
                // Show Next Exercise button or complete session
                if (completedExercises.length >= currentExercise.total_exercises) {
                    // All exercises done, show completion after a delay
                    setTimeout(() => {
                        completeSession();
                    }, 3000);
                } else {
                    // Show Next Exercise button
                    document.getElementById('nextExerciseBtn').style.display = 'inline-block';
                }
                
            }, 2000);
        }
        
        // Skip exercise
        function skipExercise() {
            if (completedExercises.length >= currentExercise.total_exercises - 1) {
                completeSession();
            } else {
                loadNextExercise();
            }
        }
        
        // Load next exercise (called from Next Exercise button)
        async function loadNextExercise() {
            // Hide Next Exercise button
            document.getElementById('nextExerciseBtn').style.display = 'none';
            
            // Show Record and Skip buttons again
            document.getElementById('recordBtn').style.display = 'inline-block';
            document.getElementById('skipBtn').style.display = 'inline-block';
            
            // Check if we should use API or sample exercises
            if (currentSession) {
                // Use API to get next exercise
                try {
                    const response = await fetch(`/api/therapy/current-exercise/${currentSession}`);
                    const data = await response.json();
                    
                    if (data.completed) {
                        // Session complete
                        completeSession();
                        return;
                    }
                    
                    if (data.exercise) {
                        currentExercise = data.exercise;
                        displayCurrentExercise();
                        updateProgressIndicator();
                        return;
                    }
                } catch (error) {
                    console.error('Error fetching next exercise:', error);
                    // Fall back to sample exercise
                }
            }
            
            // Fall back to sample exercise if API fails or no session
            loadSampleExercise();
        }
        
        // Update session stats
        function updateSessionStats(score) {
            // Update session score
            const currentScore = parseInt(document.getElementById('sessionScore').textContent);
            const newScore = Math.max(currentScore, score);
            document.getElementById('sessionScore').textContent = newScore;
            
            // Update exercises done
            document.getElementById('exercisesDone').textContent = completedExercises.length;
            
            // Update dashboard stats
            document.getElementById('bestScore').textContent = 
                Math.max(parseInt(document.getElementById('bestScore').textContent), score);
        }
        
        // Show exercise feedback
        function showExerciseFeedback(score) {
            let feedback = '';
            let color = 'success';
            
            if (score >= 85) {
                feedback = 'Excellent! Perfect clarity.';
                color = 'success';
            } else if (score >= 70) {
                feedback = 'Good job! Clear speech.';
                color = 'primary';
            } else if (score >= 60) {
                feedback = 'Fair. Try speaking slower.';
                color = 'warning';
            } else {
                feedback = 'Needs practice. Focus on articulation.';
                color = 'danger';
            }
            
            document.getElementById('feedbackContainer').innerHTML = `
                <div class="alert alert-${color}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5><i class="fas fa-chart-bar"></i> Score: ${score}/100</h5>
                            <p class="mb-0">${feedback}</p>
                        </div>
                        <div class="text-end">
                            <div class="h1 mb-0">${score}</div>
                            <small>Clarity</small>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6><i class="fas fa-lightbulb"></i> Suggestion:</h6>
                        <p class="mb-0">${getRandomSuggestion()}</p>
                    </div>
                </div>
                ${completedExercises.length < currentExercise.total_exercises ? 
                    '<div class="text-center mt-3"><button class="btn btn-success btn-lg" onclick="loadNextExercise()"><i class="fas fa-arrow-right me-2"></i>Next Exercise</button></div>' : 
                    ''}
            `;
        }
        
        // Get random suggestion
        function getRandomSuggestion() {
            const suggestions = [
                "Take a deep breath before speaking",
                "Speak a bit slower for better clarity",
                "Focus on consonant endings",
                "Use more breath support",
                "Practice with shorter phrases first"
            ];
            return suggestions[Math.floor(Math.random() * suggestions.length)];
        }
        
        // Update recent exercises
        function updateRecentExercises() {
            const recentDiv = document.getElementById('recentExercises');
            
            if (completedExercises.length === 0) {
                recentDiv.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <i class="fas fa-clock fa-2x mb-3"></i>
                        <p>No exercises completed yet</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="list-group">';
            const recent = completedExercises.slice(-3).reverse();
            
            recent.forEach(item => {
                const scoreColor = item.score >= 80 ? 'success' : item.score >= 60 ? 'warning' : 'danger';
                
                html += `
                    <div class="list-group-item border-0 p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${item.exercise.target}</strong>
                                <br>
                                <small class="text-muted">${item.exercise.type} • ${item.timestamp}</small>
                            </div>
                            <span class="badge bg-${scoreColor}">${item.score}</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            recentDiv.innerHTML = html;
        }
        
        // Complete session
        async function completeSession() {
            // Save all completed exercises to localStorage
            saveCompletedExercises();
            
            document.getElementById('sessionStatus').textContent = 'Session Complete';
            document.getElementById('sessionStatus').className = 'badge bg-secondary fs-6';
            
            const avgScore = completedExercises.length > 0 
                ? Math.round(completedExercises.reduce((sum, ex) => sum + ex.score, 0) / completedExercises.length)
                : 0;
            
            document.getElementById('currentExercise').innerHTML = `
                <div class="text-center p-4">
                    <i class="fas fa-trophy fa-4x text-warning mb-3"></i>
                    <h3 class="text-success">Session Complete! 🎉</h3>
                    <p class="lead">Great work! You completed ${completedExercises.length} exercises.</p>
                    
                    <div class="row mt-4">
                        <div class="col-4">
                            <div class="p-3 bg-light rounded">
                                <div class="h2 fw-bold">${completedExercises.length}</div>
                                <small>Exercises</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 bg-light rounded">
                                <div class="h2 fw-bold">${document.getElementById('sessionScore').textContent}</div>
                                <small>Best Score</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 bg-light rounded">
                                <div class="h2 fw-bold">${avgScore}</div>
                                <small>Avg Score</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-primary me-2" onclick="showExerciseHistory()">
                            <i class="fas fa-list me-2"></i>Review All Exercises
                        </button>
                        <button class="btn btn-success" onclick="startTherapySession()">
                            <i class="fas fa-play me-2"></i>Start New Session
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('progressIndicator').style.display = 'none';
            document.getElementById('sessionControls').style.display = 'none';
            
            // Update recent activity immediately
            updateRecentActivityFromSavedExercises();
            
            // Reload user profile to get updated stats
            await loadUserProfile();
        }
        
        // Initialize charts
        function initializeCharts() {
            // Progress Chart
            const progressCtx = document.getElementById('progressChart').getContext('2d');
            progressChart = new Chart(progressCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Clarity Score',
                        data: [65, 68, 72, 70, 75, 78],
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '6-Month Progress'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            
            // Monthly Chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Sessions Completed',
                        data: [3, 4, 5, 4],
                        backgroundColor: [
                            '#4cc9f0',
                            '#4361ee', 
                            '#3a0ca3',
                            '#7209b7'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Monthly Activity'
                        }
                    }
                }
            });
        }
        
        // Update progress charts
        function updateProgressCharts() {
            // Update progress chart with new data
            if (progressChart && completedExercises.length > 0) {
                const latestScore = completedExercises[completedExercises.length - 1].score;
                progressChart.data.datasets[0].data.push(latestScore);
                progressChart.data.labels.push('Now');
                progressChart.update();
            }
        }
    </script>
</body>
</html>
