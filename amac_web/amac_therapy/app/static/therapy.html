<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMAC Speech Therapy Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎤</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #5B8DEF;
            --primary-dark: #4A7BD9;
            --primary-light: #7BA3F3;
            --secondary-color: #EAF1FF;
            --accent-color: #7ED1B2;
            --text-color: #1F2A44;
            --text-light: #5A6B8A;
            --bg-color: #FFFFFF;
            --success-color: #7ED1B2;
            --success-light: #A5E4CC;
            --warning-color: #F6C262;
            --danger-color: #F87171;
            --sidebar-width: 280px;
            --border-radius: 20px;
            --card-shadow: 0 10px 40px rgba(91, 141, 239, 0.12);
            --glass-bg: rgba(255,255,255,0.95);
            --glass-border: rgba(234, 241, 255, 0.8);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #FFFFFF 0%, #EAF1FF 50%, #FFFFFF 100%);
            min-height: 100vh;
            position: relative;
            color: var(--text-color);
        }
        
        /* Animated Background Shapes */
        body::before {
            content: '';
            position: fixed;
            width: 500px;
            height: 500px;
            background: linear-gradient(135deg, rgba(91, 141, 239, 0.1), rgba(126, 209, 178, 0.08));
            border-radius: 50%;
            top: -200px;
            right: -100px;
            z-index: -1;
            animation: floatBg 20s ease-in-out infinite;
            pointer-events: none;
        }
        
        body::after {
            content: '';
            position: fixed;
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, rgba(126, 209, 178, 0.1), rgba(91, 141, 239, 0.08));
            border-radius: 50%;
            bottom: -150px;
            left: 200px;
            z-index: -1;
            animation: floatBg 25s ease-in-out infinite reverse;
            pointer-events: none;
        }
        
        @keyframes floatBg {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.05); }
            66% { transform: translate(-20px, 20px) scale(0.95); }
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            border-right: 1px solid var(--glass-border);
            box-shadow: 4px 0 30px rgba(0,0,0,0.05);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 28px 25px;
            background: linear-gradient(135deg, var(--primary-color), #4A7BD9);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .sidebar-header::before {
            content: '';
            position: absolute;
            width: 180px;
            height: 180px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            top: -60px;
            right: -60px;
            animation: pulse 4s ease-in-out infinite;
        }
        
        .sidebar-header::after {
            content: '';
            position: absolute;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.08);
            border-radius: 50%;
            bottom: -30px;
            left: -30px;
            animation: pulse 5s ease-in-out infinite reverse;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .sidebar-header h4 {
            font-weight: 800;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }
        
        .sidebar-header p {
            opacity: 0.9;
            font-size: 13px;
            margin-top: 6px;
            font-weight: 500;
            letter-spacing: 0.3px;
            position: relative;
            z-index: 1;
        }
        
        .nav {
            flex: 1;
            padding: 25px 18px;
        }
        
        .nav-link {
            padding: 15px 20px;
            border-radius: 14px;
            color: #64748b;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .nav-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: linear-gradient(135deg, rgba(91, 141, 239, 0.1), rgba(126, 209, 178, 0.1));
            transition: width 0.3s ease;
            border-radius: 14px;
        }
        
        .nav-link:hover::before {
            width: 100%;
        }
        
        .nav-link:hover {
            color: var(--primary-color);
            transform: translateX(6px);
        }
        
        .nav-link.active {
            background: linear-gradient(135deg, var(--primary-color), #4A7BD9);
            color: white;
            box-shadow: 0 8px 25px rgba(91, 141, 239, 0.35);
            transform: translateX(3px);
        }
        
        .nav-link.active::before {
            display: none;
        }
        
        .nav-link i {
            width: 26px;
            text-align: center;
            margin-right: 14px;
            font-size: 17px;
            position: relative;
            z-index: 1;
        }
        
        .nav-link span {
            position: relative;
            z-index: 1;
        }
        
        .sidebar-footer {
            padding: 22px;
            border-top: 1px solid rgba(0,0,0,0.06);
            background: rgba(249, 250, 251, 0.5);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .user-profile:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(91, 141, 239, 0.3);
        }
        
        .user-info h6 {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 3px;
            font-size: 15px;
        }
        
        .user-info small {
            color: #64748b;
            font-size: 12px;
            font-weight: 500;
        }
        
        .logout-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            color: var(--danger-color);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            margin-top: 12px;
            font-weight: 600;
        }
        
        .logout-link:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            transform: translateX(5px);
        }
        
        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 30px 35px;
            min-height: 100vh;
            position: relative;
            z-index: 10;
            display: block !important;
        }
        
        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }
        
        .page-header h1 {
            font-size: 32px;
            font-weight: 800;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 14px;
            letter-spacing: -0.5px;
        }
        
        .page-header h1 i {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .page {
            display: none;
            position: relative;
            z-index: 100;
        }
        
        .page.active {
            display: block !important;
            position: relative;
            z-index: 100;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cards */
        .dashboard-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 28px;
            margin-bottom: 28px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color), #5B8DEF);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.12);
        }
        
        .dashboard-card:hover::before {
            opacity: 1;
        }
        
        .dashboard-card h4 {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 22px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .dashboard-card h4 i {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, rgba(91, 141, 239, 0.15), rgba(126, 209, 178, 0.15));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-size: 16px;
        }
        
        /* Stats Cards */
        .stat-card {
            text-align: center;
            padding: 30px 25px;
            border-radius: var(--border-radius);
            color: white;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        .stat-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            width: 150px;
            height: 150px;
            background: rgba(255,255,255,0.12);
            border-radius: 50%;
            top: -50px;
            right: -50px;
            transition: all 0.5s ease;
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.08);
            border-radius: 50%;
            bottom: -30px;
            left: -30px;
            transition: all 0.5s ease;
        }
        
        .stat-card:hover::before {
            transform: scale(1.2);
        }
        
        .stat-card:hover::after {
            transform: scale(1.3);
        }
        
        .stat-card i {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }
        
        .stat-number {
            font-size: 3.2rem;
            font-weight: 800;
            margin: 10px 0;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-card small {
            opacity: 0.95;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }
        
        /* Gradient backgrounds for stat cards */
        .stat-card:nth-child(1) { background: linear-gradient(135deg, #5B8DEF, #4A7BD9); }
        .stat-card:nth-child(2) { background: linear-gradient(135deg, #7ED1B2, #5BC49A); }
        .stat-card:nth-child(3) { background: linear-gradient(135deg, #F6C262, #E8A84A); }
        .stat-card:nth-child(4) { background: linear-gradient(135deg, #5B8DEF, #7ED1B2); }
        
        /* Progress Rings */
        .progress-ring {
            width: 120px;
            height: 120px;
        }
        
        /* Exercise Cards */
        .exercise-card {
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            border-radius: 14px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid var(--primary-color);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .exercise-card:hover {
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left-color: var(--secondary-color);
        }
        
        /* Feedback Bubbles */
        .feedback-bubble {
            background: linear-gradient(135deg, rgba(91, 141, 239, 0.08), rgba(126, 209, 178, 0.05));
            border-radius: 14px;
            padding: 16px 20px;
            margin: 12px 0;
            border-left: 4px solid var(--accent-color);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .feedback-bubble:hover {
            transform: translateX(8px);
            box-shadow: 0 5px 20px rgba(91, 141, 239, 0.1);
            background: linear-gradient(135deg, rgba(91, 141, 239, 0.12), rgba(126, 209, 178, 0.08));
        }
        
        /* Session Controls */
        .session-controls {
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 100;
        }
        
        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #4A7BD9);
            border: none;
            padding: 14px 28px;
            border-radius: 14px;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(91, 141, 239, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(91, 141, 239, 0.45);
            background: linear-gradient(135deg, #4A7BD9, var(--primary-color));
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #16a34a);
            border: none;
            padding: 14px 28px;
            border-radius: 14px;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(34, 197, 94, 0.45);
        }
        
        .btn-outline-primary {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 12px;
            padding: 10px 22px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-outline-primary:hover {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-color: transparent;
            transform: translateY(-2px);
        }
        
        /* Video Preview */
        .video-container {
            position: relative;
            border-radius: 18px;
            overflow: hidden;
            background: linear-gradient(135deg, #1e293b, #334155);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .video-container video {
            width: 100%;
            border-radius: 18px;
        }
        
        /* Recording Animation */
        .recording-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(239, 68, 68, 0.95);
            color: white;
            padding: 10px 16px;
            border-radius: 24px;
            font-size: 12px;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        
        .recording-indicator .dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: recPulse 1s infinite;
        }
        
        @keyframes recPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }
        
        /* Progress Bar */
        .progress {
            background: linear-gradient(135deg, #e2e8f0, #f1f5f9);
            border-radius: 12px;
            overflow: hidden;
            height: 10px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .progress-bar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            padding: 15px;
        }
        
        /* Badge Styling */
        .badge {
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 700;
            letter-spacing: 0.3px;
        }
        
        .badge.bg-info {
            background: linear-gradient(135deg, #06b6d4, #0891b2) !important;
        }
        
        .badge.bg-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)) !important;
        }
        
        .badge.bg-success {
            background: linear-gradient(135deg, var(--success-color), #16a34a) !important;
        }
        
        /* Form Checks */
        .form-check {
            padding: 16px 18px 16px 50px;
            background: linear-gradient(135deg, rgba(249,250,251,0.8), rgba(241,245,249,0.8));
            border-radius: 14px;
            margin-bottom: 12px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            position: relative;
        }
        
        .form-check:hover {
            background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(139,92,246,0.05));
            border-color: rgba(99,102,241,0.2);
            transform: translateX(5px);
        }
        
        .form-check-input {
            width: 22px;
            height: 22px;
            margin-top: 0;
            cursor: pointer;
        }
        
        .form-check-input:checked {
            background-color: var(--success-color);
            border-color: var(--success-color);
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
        }
        
        .form-check-input:checked ~ .form-check-label {
            text-decoration: line-through;
            color: #94a3b8;
        }
        
        .form-check-label {
            font-weight: 500;
            color: #334155;
            cursor: pointer;
        }
        
        /* Score Display */
        .score-display {
            font-size: 4.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 4px 30px rgba(99, 102, 241, 0.2);
        }
        
        /* Table Styling */
        .table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .table thead th {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: none;
            padding: 16px 18px;
            font-weight: 700;
            color: #334155;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        .table tbody tr {
            transition: all 0.3s ease;
        }
        
        .table tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }
        
        .table tbody td {
            padding: 16px 18px;
            border-color: #f1f5f9;
            vertical-align: middle;
        }
        
        /* Accordion Styling */
        .accordion-item {
            border: none;
            margin-bottom: 12px;
            border-radius: 16px !important;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
        }
        
        .accordion-button {
            font-weight: 700;
            background: white;
            border-radius: 12px !important;
        }
        
        .accordion-button:not(.collapsed) {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            color: var(--primary-color);
        }
        
        /* Modal Styling */
        .modal-content {
            border-radius: 20px;
            border: none;
            overflow: hidden;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 22px 28px;
        }
        
        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }
        
        .modal-body {
            padding: 28px;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(241, 245, 249, 0.8);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-light), var(--secondary-color));
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            background-clip: padding-box;
        }
        
        /* Floating Action Button */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .fab {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
        }
        
        .fab-primary {
            background: linear-gradient(135deg, var(--primary-color), #4A7BD9);
            box-shadow: 0 8px 25px rgba(91, 141, 239, 0.4);
        }
        
        .fab-primary:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(91, 141, 239, 0.5);
        }
        
        .fab-success {
            background: linear-gradient(135deg, var(--accent-color), #5BC49A);
            box-shadow: 0 8px 25px rgba(126, 209, 178, 0.4);
        }
        
        .fab-success:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(126, 209, 178, 0.5);
        }
        
        .fab-info {
            background: linear-gradient(135deg, #5B8DEF, #7ED1B2);
            box-shadow: 0 8px 25px rgba(91, 141, 239, 0.4);
        }
        
        .fab-info:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(91, 141, 239, 0.5);
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
            
            .stat-card {
                margin-bottom: 15px;
            }
            
            .fab-container {
                bottom: 20px;
                right: 20px;
            }
        }
        
        /* Loading Animation */
        .loading-spinner {
            display: inline-block;
            width: 22px;
            height: 22px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }
        
        .empty-state i {
            font-size: 60px;
            background: linear-gradient(135deg, #cbd5e1, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
        }
        
        .empty-state h5 {
            color: #64748b;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .empty-state p {
            color: #94a3b8;
            font-size: 14px;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .custom-toast {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4><i class="fas fa-microphone"></i> AMAC Therapy</h4>
            <p class="mb-0">Speech Improvement System</p>
        </div>
        
        <nav class="nav flex-column">
            <a class="nav-link active" href="#" onclick="navTo('dashboard',this)">
                <i class="fas fa-home"></i> <span>Dashboard</span>
            </a>
            <a class="nav-link" href="#" onclick="navTo('translation',this)">
                <i class="fas fa-language"></i> <span>Translation</span>
            </a>
            <a class="nav-link" href="#" onclick="navTo('therapy',this)">
                <i class="fas fa-microphone-alt"></i> <span>Therapy Session</span>
            </a>
            <a class="nav-link" href="#" onclick="navTo('progress',this)">
                <i class="fas fa-chart-line"></i> <span>Progress & Charts</span>
            </a>
            <a class="nav-link" href="/feedback">
                <i class="fas fa-comment-dots"></i> <span>Overall Feedback</span>
            </a>
            <a class="nav-link" href="/help">
                <i class="fas fa-question-circle"></i> <span>Help & Support</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <h6 id="sidebarUserName">Test User</h6>
                    <small id="sidebarUserLevel">moderate</small>
                </div>
            </div>
            <a href="/logout" class="logout-link" onclick="confirmLogout(event)">
                <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Page 1: Dashboard -->
        <div id="dashboard" class="page active" style="display: block;">
            <div class="page-header">
                <h1><i class="fas fa-th-large"></i> Dashboard</h1>
                <button class="btn btn-success" onclick="startSession()">
                    <i class="fas fa-play me-2"></i>Start New Session
                </button>
            </div>
            
            <!-- Stats Row -->
            <div class="row mb-4 g-4">
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <i class="fas fa-calendar-check"></i>
                        <div class="stat-number" id="totalSessions">5</div>
                        <small>Total Sessions</small>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <i class="fas fa-trophy"></i>
                        <div class="stat-number" id="bestScore">85</div>
                        <small>Best Score</small>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <i class="fas fa-fire-alt"></i>
                        <div class="stat-number" id="dayStreak">3</div>
                        <small>Day Streak</small>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <i class="fas fa-chart-line"></i>
                        <div class="stat-number" id="avgScore">72</div>
                        <small>Avg Score</small>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity & Quick Start -->
            <div class="row">
                <div class="col-lg-8">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-history"></i>Recent Activity</h4>
                        <div id="recentActivity">
                            <div class="empty-state" id="noActivityMessage">
                                <i class="fas fa-clock"></i>
                                <h5>No Recent Activity</h5>
                                <p>Complete exercises to see your progress!</p>
                            </div>
                        </div>
                        <div class="mt-3" id="viewAllExercisesBtn" style="display: none;">
                            <button class="btn btn-outline-primary w-100" onclick="showExerciseHistory()">
                                <i class="fas fa-list me-2"></i>View All Completed Exercises
                            </button>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-bullseye"></i>Today's Goals</h4>
                        <div id="todaysGoals">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="goal1" checked>
                                <label class="form-check-label" for="goal1">
                                    Complete 1 therapy session
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="goal2">
                                <label class="form-check-label" for="goal2">
                                    Achieve 75+ clarity score
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="goal3">
                                <label class="form-check-label" for="goal3">
                                    Practice for 15 minutes
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-user-circle"></i>Patient Profile</h4>
                        <div class="text-center mt-3">
                            <div class="user-avatar mx-auto mb-3" style="width: 90px; height: 90px; font-size: 36px; border-radius: 20px;">
                                <i class="fas fa-user"></i>
                            </div>
                            <h4 id="userName" style="color: #1e293b; font-weight: 800; font-size: 22px;">Test User</h4>
                            <div class="badge bg-primary mb-4" id="impairmentLevel">moderate</div>
                            
                            <div class="text-start mt-4">
                                <div class="d-flex align-items-center mb-3 p-3" style="background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(139,92,246,0.05)); border-radius: 14px;">
                                    <div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 14px;">
                                        <i class="fas fa-calendar-alt" style="color: white; font-size: 16px;"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted" style="font-weight: 500;">Member Since</small>
                                        <div style="font-weight: 700; color: #1e293b;">Jan 2024</div>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center mb-3 p-3" style="background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(251,191,36,0.05)); border-radius: 14px;">
                                    <div style="width: 42px; height: 42px; background: linear-gradient(135deg, #f59e0b, #fbbf24); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 14px;">
                                        <i class="fas fa-star" style="color: white; font-size: 16px;"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted" style="font-weight: 500;">Current Level</small>
                                        <div style="font-weight: 700; color: #1e293b;">Intermediate</div>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center p-3" style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(74,222,128,0.05)); border-radius: 14px;">
                                    <div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--success-color), #4ade80); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 14px;">
                                        <i class="fas fa-flag-checkered" style="color: white; font-size: 16px;"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted" style="font-weight: 500;">Next Milestone</small>
                                        <div style="font-weight: 700; color: #1e293b;">10 Sessions</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-lightbulb"></i>Quick Tips</h4>
                        <div class="mt-3">
                            <div class="feedback-bubble" style="border-left-color: var(--primary-color);">
                                <i class="fas fa-volume-up me-2" style="color: var(--primary-color);"></i>
                                <strong>Speak slowly</strong> - Pace improves clarity
                            </div>
                            <div class="feedback-bubble" style="border-left-color: var(--success-color);">
                                <i class="fas fa-wind me-2" style="color: var(--success-color);"></i>
                                <strong>Use breath support</strong> - Take deep breaths
                            </div>
                            <div class="feedback-bubble" style="border-left-color: var(--warning-color);">
                                <i class="fas fa-stopwatch me-2" style="color: var(--warning-color);"></i>
                                <strong>Practice daily</strong> - Consistency is key
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 2: Translation -->
        <div id="translation" class="page" style="display: none;">
            <div class="page-header">
                <h1><i class="fas fa-language"></i> Speech Translation</h1>
                <span class="badge bg-info" id="translationStatus">Ready to Record</span>
            </div>
            
            <!-- Dysarthria Info Banner -->
            <div class="alert alert-info mb-4" style="background: linear-gradient(135deg, rgba(91, 141, 239, 0.1), rgba(126, 209, 178, 0.1)); border: 1px solid rgba(91, 141, 239, 0.3); border-radius: 16px; display: flex; align-items: flex-start; gap: 15px;">
                <i class="fas fa-info-circle fa-lg mt-1" style="color: var(--primary-color);"></i>
                <div>
                    <strong style="color: var(--text-color);">Designed for Dysarthria Patients - AI-Powered Speech Recognition & Translation</strong>
                    <p class="mb-0 mt-1" style="color: var(--text-light); font-size: 14px;">
                        <i class="fas fa-microphone-alt me-1 text-danger"></i> <strong>Audio Model:</strong> Trained to recognize dysarthria speech patterns for accurate transcription.<br>
                        <i class="fas fa-video me-1 text-warning"></i> <strong>Visual Model:</strong> Lip-reading AI enhances recognition accuracy using video input.<br>
                        <i class="fas fa-check-circle me-1 text-success"></i> <strong>Same Language Mode:</strong> Select "Clarify" options to convert your speech to clear text.<br>
                        <i class="fas fa-globe me-1 text-primary"></i> <strong>Translation Mode:</strong> Select "Translate To" options to translate your speech.<br>
                        <i class="fas fa-robot me-1 text-info"></i> <strong>AI TTS:</strong> "Speak (AI Model)" generates clear, natural pronunciation.
                    </p>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-8">
                    <!-- Recording Section -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-microphone"></i> Record Your Speech</h4>
                        <div class="mt-4">
                            <!-- Video Preview -->
                            <div class="video-container mb-4" style="position: relative; border-radius: 20px; overflow: hidden; background: linear-gradient(135deg, #1e293b, #334155);">
                                <video id="translationVideoPreview" autoplay muted playsinline style="width: 100%; border-radius: 20px; min-height: 300px;"></video>
                                <div id="translationRecordingIndicator" class="recording-indicator" style="display: none;">
                                    <span class="dot"></span>
                                    REC
                                </div>
                            </div>
                            
                            <!-- Recording Controls -->
                            <div class="text-center mb-4">
                                <button id="startTranslationRecordBtn" class="btn btn-success btn-lg me-3" onclick="startTranslationRecording()" style="border-radius: 50%; width: 80px; height: 80px;">
                                    <i class="fas fa-microphone fa-2x"></i>
                                </button>
                                <button id="stopTranslationRecordBtn" class="btn btn-danger btn-lg" onclick="stopTranslationRecording()" style="display: none; border-radius: 50%; width: 80px; height: 80px;">
                                    <i class="fas fa-stop fa-2x"></i>
                                </button>
                            </div>
                            
                            <p class="text-center text-muted" id="translationInstructions">
                                <i class="fas fa-info-circle me-2"></i>
                                Click the microphone button and start speaking. Your speech will be recognized and translated.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Transcription & Translation Results -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-file-alt"></i> Transcription & Translation</h4>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="p-4" style="background: linear-gradient(135deg, rgba(91, 141, 239, 0.08), rgba(126, 209, 178, 0.05)); border-radius: 16px; min-height: 200px;">
                                    <h6 class="mb-3" style="color: var(--primary-color); font-weight: 700;">
                                        <i class="fas fa-comment-dots me-2"></i>Original Speech
                                    </h6>
                                    <div id="originalSpeechText" style="font-size: 16px; line-height: 1.8; color: #334155;">
                                        <span class="text-muted">Your speech will appear here...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-4" style="background: linear-gradient(135deg, rgba(126, 209, 178, 0.1), rgba(91, 141, 239, 0.05)); border-radius: 16px; min-height: 200px;">
                                    <h6 class="mb-3" style="color: var(--success-color); font-weight: 700;">
                                        <i class="fas fa-globe me-2"></i>Translation
                                        <select id="targetLanguage" class="form-select form-select-sm" style="width: auto; display: inline-block; margin-left: 10px; border-radius: 8px;" onchange="checkTargetLanguage(this)">
                                            <optgroup label="Same Language (Speech Clarity)">
                                                <option value="en" selected>English (Clarify)</option>
                                                <option value="hi" data-coming-soon="true">Hindi (Coming Soon)</option>
                                                <option value="te" data-coming-soon="true">Telugu (Coming Soon)</option>
                                                <option value="ta" data-coming-soon="true">Tamil (Coming Soon)</option>
                                                <option value="es" data-coming-soon="true">Spanish (Coming Soon)</option>
                                                <option value="fr" data-coming-soon="true">French (Coming Soon)</option>
                                                <option value="de" data-coming-soon="true">German (Coming Soon)</option>
                                            </optgroup>
                                            <optgroup label="Translate To (Coming Soon)">
                                                <option value="es-trans" data-coming-soon="true">Spanish</option>
                                                <option value="fr-trans" data-coming-soon="true">French</option>
                                                <option value="de-trans" data-coming-soon="true">German</option>
                                                <option value="hi-trans" data-coming-soon="true">Hindi</option>
                                                <option value="te-trans" data-coming-soon="true">Telugu</option>
                                                <option value="ta-trans" data-coming-soon="true">Tamil</option>
                                                <option value="zh-trans" data-coming-soon="true">Chinese</option>
                                                <option value="ja-trans" data-coming-soon="true">Japanese</option>
                                                <option value="ko-trans" data-coming-soon="true">Korean</option>
                                                <option value="ar-trans" data-coming-soon="true">Arabic</option>
                                                <option value="pt-trans" data-coming-soon="true">Portuguese</option>
                                                <option value="ru-trans" data-coming-soon="true">Russian</option>
                                            </optgroup>
                                        </select>
                                    </h6>
                                    <div id="translatedText" style="font-size: 16px; line-height: 1.8; color: #334155;">
                                        <span class="text-muted">Translation will appear here...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="mt-4 text-center">
                            <button class="btn btn-primary me-3" onclick="speakWithBrowserTTS()" id="speakBrowserBtn" disabled style="border-radius: 12px; padding: 12px 24px;" title="Speak the translation aloud">
                                <i class="fas fa-volume-up me-2"></i>Speak
                            </button>
                            <button class="btn btn-outline-secondary me-3" onclick="copyTranslation()" id="copyTranslationBtn" disabled style="border-radius: 12px; padding: 12px 24px;">
                                <i class="fas fa-copy me-2"></i>Copy
                            </button>
                            <button class="btn btn-outline-danger" onclick="clearTranslation()" style="border-radius: 12px; padding: 12px 24px;">
                                <i class="fas fa-trash me-2"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <!-- Language Settings -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-cog"></i> Settings</h4>
                        <div class="mt-3">
                            <label class="form-label fw-600">Source Language</label>
                            <select id="sourceLanguage" class="form-select mb-3" style="border-radius: 12px; padding: 12px;" onchange="checkSourceLanguage(this)">
                                <option value="en-US">English (US)</option>
                                <option value="en-GB">English (UK)</option>
                                <option value="hi-IN" data-coming-soon="true">Hindi (Coming Soon)</option>
                                <option value="te-IN" data-coming-soon="true">Telugu (Coming Soon)</option>
                                <option value="ta-IN" data-coming-soon="true">Tamil (Coming Soon)</option>
                                <option value="es-ES" data-coming-soon="true">Spanish (Coming Soon)</option>
                                <option value="fr-FR" data-coming-soon="true">French (Coming Soon)</option>
                                <option value="de-DE" data-coming-soon="true">German (Coming Soon)</option>
                            </select>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="continuousMode" checked style="width: 50px; height: 26px;">
                                <label class="form-check-label fw-500" for="continuousMode">Continuous Recognition</label>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="autoTranslate" checked style="width: 50px; height: 26px;">
                                <label class="form-check-label fw-500" for="autoTranslate">Auto-Translate</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Translation History -->
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4 class="mb-0"><i class="fas fa-history"></i> Recent Translations</h4>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearTranslationHistoryStorage()" title="Clear all history" style="border-radius: 8px; font-size: 11px;">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        <div id="translationHistory" class="mt-3" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center p-4">
                                <i class="fas fa-clock fa-2x mb-3" style="color: #d1d5db;"></i>
                                <p class="text-muted mb-0">No translations yet</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Tips -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-lightbulb"></i> Tips</h4>
                        <div class="mt-3">
                            <div class="feedback-bubble" style="border-left-color: var(--primary-color);">
                                <i class="fas fa-microphone me-2" style="color: var(--primary-color);"></i>
                                <strong>Speak clearly</strong> - Enunciate each word
                            </div>
                            <div class="feedback-bubble" style="border-left-color: var(--success-color);">
                                <i class="fas fa-volume-down me-2" style="color: var(--success-color);"></i>
                                <strong>Quiet environment</strong> - Reduce background noise
                            </div>
                            <div class="feedback-bubble" style="border-left-color: var(--warning-color);">
                                <i class="fas fa-pause me-2" style="color: var(--warning-color);"></i>
                                <strong>Pause between sentences</strong> - Better accuracy
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Therapy Session -->
        <div id="therapy" class="page" style="display: none;">
            <div class="page-header">
                <h1><i class="fas fa-microphone-alt"></i>Therapy Session</h1>
                <span class="badge bg-primary" id="sessionStatus" style="cursor: pointer;" onclick="handleSessionStatusClick()">Ready to Start</span>
            </div>
            
            <div class="row">
                <div class="col-lg-8">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-tasks"></i>Current Exercise</h4>
                        <div id="currentExercise" class="text-center p-5">
                            <div style="width: 100px; height: 100px; margin: 0 auto 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-play fa-3x" style="color: var(--primary-color);"></i>
                            </div>
                            <h3 style="color: #1a1a2e; font-weight: 700;">Ready to Start Therapy</h3>
                            <p class="text-muted mb-4">Click "Start Session" to begin your speech exercises</p>
                            <button class="btn btn-success btn-lg" onclick="showMotivationalModal()">
                                <i class="fas fa-play me-2"></i>Start Session
                            </button>
                        </div>
                        
                        <!-- Progress Indicator -->
                        <div class="mt-4" id="progressIndicator" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="fw-600">Session Progress</small>
                                <small class="fw-600" id="progressText">0/0 exercises</small>
                            </div>
                            <div class="progress">
                                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Session Controls -->
                        <div class="mt-4 text-center" id="sessionControls" style="display: none;">
                            <button id="recordBtn" class="btn btn-primary btn-lg me-3" onclick="recordAttempt()">
                                <i class="fas fa-microphone me-2"></i>Record Attempt
                            </button>
                            <button id="skipBtn" class="btn btn-outline-secondary me-3" onclick="skipExercise()" style="border-radius: 12px; padding: 12px 24px;">
                                <i class="fas fa-forward me-2"></i>Skip
                            </button>
                            <button id="nextExerciseBtn" class="btn btn-success btn-lg" onclick="loadNextExercise()" style="display: none;">
                                <i class="fas fa-arrow-right me-2"></i>Next Exercise
                            </button>
                        </div>
                    </div>
                    
                    <!-- Real-time Feedback -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-comment-dots"></i>Real-time Feedback</h4>
                        <div id="feedbackContainer" class="mt-3">
                            <div class="text-center p-4">
                                <i class="fas fa-info-circle fa-3x mb-3" style="color: #d1d5db;"></i>
                                <p class="text-muted mb-0">Complete exercises to receive personalized feedback</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <!-- Camera Preview -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-video"></i>Camera Preview</h4>
                        <div class="mt-3">
                            <div class="video-container">
                                <video id="videoPreview" autoplay muted playsinline></video>
                                <div id="recordingIndicator" class="recording-indicator" style="display: none;">
                                    <span class="dot"></span>
                                    REC
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted" id="cameraStatus">Camera ready</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Exercises -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-history"></i>Recent Exercises</h4>
                        <div id="recentExercises" class="mt-3">
                            <div class="text-center p-3">
                                <i class="fas fa-clock fa-2x mb-3" style="color: #d1d5db;"></i>
                                <p class="text-muted mb-0">No exercises completed yet</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-bar"></i>Session Stats</h4>
                        <div class="row text-center mt-3">
                            <div class="col-6">
                                <div class="p-3" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border-radius: 12px;">
                                    <div class="score-display" id="sessionScore" style="font-size: 2.5rem;">0</div>
                                    <small class="fw-500">Current Score</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border-radius: 12px;">
                                    <div class="h2 fw-bold" id="exercisesDone" style="color: var(--success-color);">0</div>
                                    <small class="fw-500">Exercises Done</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Progress & Charts -->
        <div id="progress" class="page" style="display: none;">
            <div class="page-header">
                <h1><i class="fas fa-chart-line"></i>Progress & Charts</h1>
            </div>
            
            <div class="row">
                <div class="col-lg-8">
                    <!-- Progress Chart -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-area"></i>Progress Over Time</h4>
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Monthly Performance -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-calendar-alt"></i>Monthly Performance</h4>
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <!-- Statistics -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-pie"></i>Statistics</h4>
                        <div class="mt-4">
                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-2">
                                    <small class="fw-600">Overall Improvement</small>
                                    <small class="fw-bold" id="overallImprovementPercent" style="color: var(--success-color);">0%</small>
                                </div>
                                <div class="progress">
                                    <div id="overallImprovementBar" class="progress-bar" style="width: 0%; background: linear-gradient(135deg, var(--success-color), #059669);"></div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-2">
                                    <small class="fw-600">Consistency Score</small>
                                    <small class="fw-bold" id="consistencyScorePercent" style="color: #06b6d4;">0%</small>
                                </div>
                                <div class="progress">
                                    <div id="consistencyScoreBar" class="progress-bar" style="width: 0%; background: linear-gradient(135deg, #06b6d4, #0891b2);"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <small class="fw-600">Articulation Accuracy</small>
                                    <small class="fw-bold" id="articulationPercent" style="color: var(--warning-color);">0%</small>
                                </div>
                                <div class="progress">
                                    <div id="articulationBar" class="progress-bar" style="width: 0%; background: linear-gradient(135deg, var(--warning-color), #d97706);"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Milestones -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-trophy"></i>Milestones</h4>
                        <div id="milestonesList" class="mt-3">
                            <!-- Milestones will be populated dynamically -->
                        </div>
                    </div>
                    
                    <!-- Export Options -->
                    <div class="dashboard-card">
                        <h4><i class="fas fa-download"></i>Export Progress</h4>
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-primary w-100 mb-2" id="pdfDownloadBtn">
                                <i class="fas fa-file-pdf me-2"></i>Download PDF Report
                            </button>
                            <button type="button" class="btn btn-outline-secondary w-100" style="border-radius: 12px; padding: 10px 22px;" id="csvExportBtn">
                                <i class="fas fa-chart-bar me-2"></i>Export Data (CSV)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 4: Overall Feedback -->
        <div id="feedback" class="page" style="display: none; position: relative; z-index: 100; background: #f8f9fa; min-height: 500px;">
            <div style="background: #6366f1; color: white; padding: 20px; margin-bottom: 20px; border-radius: 10px;">
                <h1 style="color: white; font-size: 28px; margin: 0;"><i class="fas fa-comment-dots"></i> Overall Feedback</h1>
            </div>
            
            <div class="row">
                <div class="col-lg-8">
                    <!-- Performance Summary -->
                    <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-star"></i> Performance Summary</h4>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="text-center p-4" style="background: linear-gradient(135deg, #f0f4ff, #e8ecf4); border-radius: 15px;">
                                    <h5 style="font-weight: 600; margin-bottom: 15px; color: #333;">Clarity Score</h5>
                                    <div id="feedbackClarityScore" style="font-size: 64px; font-weight: 700; color: #6366f1;">0</div>
                                    <p style="color: #666; margin-top: 10px;">out of 100</p>
                                    <div class="progress mt-3 mx-auto" style="max-width: 200px; height: 10px; border-radius: 5px;">
                                        <div id="feedbackClarityBar" class="progress-bar" style="width: 0%; background: linear-gradient(135deg, #6366f1, #8b5cf6);"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5 style="font-weight: 600; margin-bottom: 15px; color: #333;">Strengths</h5>
                                <div style="background: #f0fff4; padding: 12px 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #22c55e;">
                                    <i class="fas fa-check-circle me-2" style="color: #22c55e;"></i>
                                    <strong>Vowel Sounds</strong> - Excellent clarity
                                </div>
                                <div style="background: #f0fff4; padding: 12px 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #22c55e;">
                                    <i class="fas fa-check-circle me-2" style="color: #22c55e;"></i>
                                    <strong>Pacing</strong> - Good speech rate
                                </div>
                                <div style="background: #f0fff4; padding: 12px 15px; border-radius: 10px; border-left: 4px solid #22c55e;">
                                    <i class="fas fa-check-circle me-2" style="color: #22c55e;"></i>
                                    <strong>Consistency</strong> - Regular practice
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Areas for Improvement -->
                    <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-bullseye"></i> Areas for Improvement</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div style="padding: 20px; border-radius: 12px; border-left: 4px solid #f59e0b; background: #fffbeb;">
                                    <h6><i class="fas fa-exclamation-triangle me-2" style="color: #f59e0b;"></i>Sibilant Sounds</h6>
                                    <p style="color: #666; margin-bottom: 10px;">Work on "S", "SH", "Z" sounds</p>
                                    <div class="progress" style="height: 8px; border-radius: 4px;">
                                        <div class="progress-bar" style="width: 65%; background: #f59e0b;"></div>
                                    </div>
                                    <small style="color: #888;">Current: 65% accuracy</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div style="padding: 20px; border-radius: 12px; border-left: 4px solid #f59e0b; background: #fffbeb;">
                                    <h6><i class="fas fa-exclamation-triangle me-2" style="color: #f59e0b;"></i>Consonant Clusters</h6>
                                    <p style="color: #666; margin-bottom: 10px;">Practice "STR", "SPL", "THR"</p>
                                    <div class="progress" style="height: 8px; border-radius: 4px;">
                                        <div class="progress-bar" style="width: 58%; background: #f59e0b;"></div>
                                    </div>
                                    <small style="color: #888;">Current: 58% accuracy</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Therapist Notes -->
                    <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-sticky-note"></i> Therapist Notes</h4>
                        <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <div style="width: 45px; height: 45px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 15px;">
                                    <i class="fas fa-user-md"></i>
                                </div>
                                <div>
                                    <strong style="color: #333;">Dr. Smith</strong>
                                    <small style="color: #888; display: block;">Speech Therapist</small>
                                </div>
                            </div>
                            <p style="color: #555; font-style: italic;">"Great progress with vowel sounds. Focus on consonant endings and breath support for longer sentences. Practice daily for 15 minutes."</p>
                            <small style="color: #888;"><i class="fas fa-clock me-1"></i>Last updated: 2 days ago</small>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <!-- Recommendations -->
                    <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-lightbulb"></i> Recommendations</h4>
                        <div style="background: #f0f4ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #6366f1;">
                            <i class="fas fa-dumbbell me-2" style="color: #6366f1;"></i>
                            <strong>Daily Exercises:</strong>
                            <ul style="margin-top: 10px; padding-left: 20px; color: #555;">
                                <li>5 min "S" sound practice</li>
                                <li>10 min sentence reading</li>
                                <li>5 min breathing exercises</li>
                            </ul>
                        </div>
                        <div style="background: #f0fff4; padding: 15px; border-radius: 10px; border-left: 4px solid #22c55e;">
                            <i class="fas fa-calendar-check me-2" style="color: #22c55e;"></i>
                            <strong>Schedule:</strong>
                            <p style="margin-top: 10px; color: #555; margin-bottom: 0;">Morning: 10 AM - Best time<br>Evening: Review progress</p>
                        </div>
                    </div>
                    
                    <!-- Progress Timeline -->
                    <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-history"></i> Progress Timeline</h4>
                        <div id="feedbackProgressTimeline" style="padding-left: 30px; position: relative;">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-clock fa-2x mb-2" style="color: #d1d5db;"></i>
                                <p class="mb-0">No sessions completed yet</p>
                                <small>Complete therapy sessions to see your progress</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 5: Help & Support -->
        <div id="help" class="page" style="display: none; position: relative; z-index: 100; background: #f8f9fa; min-height: 500px;">
            <div style="background: #22c55e; color: white; padding: 20px; margin-bottom: 20px; border-radius: 10px;">
                <h1 style="color: white; font-size: 28px; margin: 0;"><i class="fas fa-question-circle"></i> Help & Support</h1>
            </div>
            
            <div class="row">
                <div class="col-lg-8">
                    <!-- FAQ -->
                    <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-question"></i> Frequently Asked Questions</h4>
                        
                        <div style="border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 10px;">
                            <div style="padding: 15px; background: #f9fafb; border-radius: 10px 10px 0 0; cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">
                                <i class="fas fa-play-circle me-2" style="color: #6366f1;"></i>
                                <strong>How do I start a therapy session?</strong>
                                <i class="fas fa-chevron-down" style="float: right; color: #888;"></i>
                            </div>
                            <div style="padding: 15px; border-top: 1px solid #e5e7eb;">
                                Go to the <strong>Therapy Session</strong> page and click "Start Session". Make sure your microphone and camera are enabled.
                            </div>
                        </div>
                        
                        <div style="border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 10px;">
                            <div style="padding: 15px; background: #f9fafb; border-radius: 10px 10px 0 0; cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">
                                <i class="fas fa-calculator me-2" style="color: #6366f1;"></i>
                                <strong>How is my score calculated?</strong>
                                <i class="fas fa-chevron-down" style="float: right; color: #888;"></i>
                            </div>
                            <div style="padding: 15px; border-top: 1px solid #e5e7eb; display: none;">
                                Your score is based on speech clarity, articulation accuracy, pacing, and volume consistency. The system uses AI to analyze your speech patterns.
                            </div>
                        </div>
                        
                        <div style="border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 10px;">
                            <div style="padding: 15px; background: #f9fafb; border-radius: 10px 10px 0 0; cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">
                                <i class="fas fa-stopwatch me-2" style="color: #6366f1;"></i>
                                <strong>How often should I practice?</strong>
                                <i class="fas fa-chevron-down" style="float: right; color: #888;"></i>
                            </div>
                            <div style="padding: 15px; border-top: 1px solid #e5e7eb; display: none;">
                                For best results, practice daily for 15-20 minutes. Consistency is more important than long sessions.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Troubleshooting -->
                    <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-tools"></i> Troubleshooting</h4>
                        <div class="row mt-3 g-3">
                            <div class="col-md-6">
                                <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #ef4444; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                                    <h6><i class="fas fa-microphone-slash me-2" style="color: #ef4444;"></i>Microphone Issues</h6>
                                    <p style="color: #666; margin-bottom: 0;">Check browser permissions and ensure microphone is not muted.</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #ef4444; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                                    <h6><i class="fas fa-video-slash me-2" style="color: #ef4444;"></i>Camera Issues</h6>
                                    <p style="color: #666; margin-bottom: 0;">Allow camera access in browser settings and ensure good lighting.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <!-- Contact Support -->
                    <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-headset"></i> Contact Support</h4>
                        <div class="mt-3">
                            <div style="background: #f0f4ff; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #6366f1;">
                                <i class="fas fa-envelope me-2" style="color: #6366f1;"></i>
                                <strong>Email:</strong> support@amac-therapy.com
                            </div>
                            <div style="background: #f0fff4; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #22c55e;">
                                <i class="fas fa-phone me-2" style="color: #22c55e;"></i>
                                <strong>Phone:</strong> 1-800-AMAC-HELP
                            </div>
                            <div style="background: #fffbeb; padding: 15px; border-radius: 10px; border-left: 4px solid #f59e0b;">
                                <i class="fas fa-clock me-2" style="color: #f59e0b;"></i>
                                <strong>Hours:</strong> Mon-Fri, 9 AM - 5 PM
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Links -->
                    <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-link"></i> Quick Links</h4>
                        <div class="mt-3">
                            <button style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #6366f1; background: white; color: #6366f1; border-radius: 10px; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-book me-2"></i>User Guide
                            </button>
                            <button style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #888; background: white; color: #555; border-radius: 10px; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-video me-2"></i>Video Tutorials
                            </button>
                            <button style="width: 100%; padding: 12px; border: none; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border-radius: 10px; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-file-download me-2"></i>Download Resources
                            </button>
                        </div>
                    </div>
                    
                    <!-- System Status -->
                    <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-server"></i> System Status</h4>
                        <div class="mt-3">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 10px; margin-bottom: 10px;">
                                <span style="font-weight: 500; color: #333;">Speech Recognition</span>
                                <span style="background: #22c55e; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Online</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 10px; margin-bottom: 10px;">
                                <span style="font-weight: 500; color: #333;">AI Analysis</span>
                                <span style="background: #22c55e; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Online</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 10px; margin-bottom: 10px;">
                                <span style="font-weight: 500; color: #333;">Progress Tracking</span>
                                <span style="background: #22c55e; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Online</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 10px;">
                                <span style="font-weight: 500; color: #333;">Database</span>
                                <span style="background: #22c55e; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Online</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TEST FEEDBACK PAGE - OUTSIDE MAIN CONTENT -->
    <div id="test-feedback-page" style="display: none; position: fixed; top: 0; left: 280px; right: 0; bottom: 0; background: white; z-index: 9998; padding: 30px; overflow-y: auto;">
        <h1 style="color: #6366f1; margin-bottom: 30px;"><i class="fas fa-comment-dots"></i> Overall Feedback</h1>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
            <div>
                <!-- Performance Summary -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-star"></i> Performance Summary</h4>
                    <div style="display: flex; gap: 20px;">
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f0f4ff, #e8ecf4); border-radius: 15px; flex: 1;">
                            <h5 style="color: #333;">Clarity Score</h5>
                            <div style="font-size: 64px; font-weight: 700; color: #6366f1;">72</div>
                            <p style="color: #666;">out of 100</p>
                        </div>
                        <div style="flex: 1;">
                            <h5 style="color: #333; margin-bottom: 15px;">Strengths</h5>
                            <div style="background: #f0fff4; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #22c55e;">
                                <i class="fas fa-check-circle" style="color: #22c55e;"></i> <strong>Vowel Sounds</strong> - Excellent clarity
                            </div>
                            <div style="background: #f0fff4; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #22c55e;">
                                <i class="fas fa-check-circle" style="color: #22c55e;"></i> <strong>Pacing</strong> - Good speech rate
                            </div>
                            <div style="background: #f0fff4; padding: 12px; border-radius: 10px; border-left: 4px solid #22c55e;">
                                <i class="fas fa-check-circle" style="color: #22c55e;"></i> <strong>Consistency</strong> - Regular practice
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Areas for Improvement -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-bullseye"></i> Areas for Improvement</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: #fffbeb; padding: 15px; border-radius: 12px; border-left: 4px solid #f59e0b;">
                            <h6><i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> "S" Sound Clarity</h6>
                            <p style="color: #666; margin: 0;">Practice tongue position for clearer S sounds</p>
                        </div>
                        <div style="background: #fffbeb; padding: 15px; border-radius: 12px; border-left: 4px solid #f59e0b;">
                            <h6><i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Word Endings</h6>
                            <p style="color: #666; margin: 0;">Focus on completing consonant endings</p>
                        </div>
                    </div>
                </div>
                
                <!-- Therapist Notes -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-sticky-note"></i> Therapist Notes</h4>
                    <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 45px; height: 45px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 15px;">
                                <i class="fas fa-user-md"></i>
                            </div>
                            <div>
                                <strong>Dr. Smith</strong>
                                <small style="display: block; color: #888;">Speech Therapist</small>
                            </div>
                        </div>
                        <p style="color: #555; font-style: italic;">"Great progress with vowel sounds. Focus on consonant endings and breath support for longer sentences. Practice daily for 15 minutes."</p>
                        <small style="color: #888;"><i class="fas fa-clock"></i> Last updated: 2 days ago</small>
                    </div>
                </div>
            </div>
            
            <div>
                <!-- Recommendations -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-lightbulb"></i> Recommendations</h4>
                    <div style="background: #f0f4ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #6366f1;">
                        <strong><i class="fas fa-dumbbell" style="color: #6366f1;"></i> Daily Exercises:</strong>
                        <ul style="margin-top: 10px; padding-left: 20px; color: #555;">
                            <li>5 minutes of "S" sound practice</li>
                            <li>10 minutes of sentence reading</li>
                            <li>5 minutes of breathing exercises</li>
                        </ul>
                    </div>
                    <div style="background: #f0fff4; padding: 15px; border-radius: 10px; border-left: 4px solid #22c55e;">
                        <strong><i class="fas fa-calendar-check" style="color: #22c55e;"></i> Schedule:</strong>
                        <p style="margin-top: 10px; color: #555;">Morning: 10 AM - Best time for practice<br>Evening: Review progress</p>
                    </div>
                </div>
                
                <!-- Progress Timeline -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-history"></i> Progress Timeline</h4>
                    <div id="helpProgressTimeline" style="padding-left: 30px; position: relative;">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-clock fa-2x mb-2" style="color: #d1d5db;"></i>
                            <p class="mb-0">No sessions completed yet</p>
                            <small>Complete therapy sessions to see your progress</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TEST HELP PAGE - OUTSIDE MAIN CONTENT -->
    <div id="test-help-page" style="display: none; position: fixed; top: 0; left: 280px; right: 0; bottom: 0; background: white; z-index: 9998; padding: 30px; overflow-y: auto;">
        <h1 style="color: #6366f1; margin-bottom: 30px;"><i class="fas fa-question-circle"></i> Help & Support</h1>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
            <div>
                <!-- FAQ -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-question"></i> Frequently Asked Questions</h4>
                    
                    <div style="border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 10px;">
                        <div style="padding: 15px; background: #f9fafb; border-radius: 10px 10px 0 0; cursor: pointer;">
                            <i class="fas fa-play-circle" style="color: #6366f1;"></i>
                            <strong>How do I start a therapy session?</strong>
                        </div>
                        <div style="padding: 15px; border-top: 1px solid #e5e7eb;">
                            Go to the <strong>Therapy Session</strong> page and click "Start Session". Make sure your microphone and camera are enabled.
                        </div>
                    </div>
                    
                    <div style="border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 10px;">
                        <div style="padding: 15px; background: #f9fafb; border-radius: 10px 10px 0 0; cursor: pointer;">
                            <i class="fas fa-calculator" style="color: #6366f1;"></i>
                            <strong>How is my score calculated?</strong>
                        </div>
                        <div style="padding: 15px; border-top: 1px solid #e5e7eb;">
                            Your score is based on speech clarity, articulation accuracy, pacing, and volume consistency. The system uses AI to analyze your speech patterns.
                        </div>
                    </div>
                    
                    <div style="border: 1px solid #e5e7eb; border-radius: 10px;">
                        <div style="padding: 15px; background: #f9fafb; border-radius: 10px 10px 0 0; cursor: pointer;">
                            <i class="fas fa-stopwatch" style="color: #6366f1;"></i>
                            <strong>How often should I practice?</strong>
                        </div>
                        <div style="padding: 15px; border-top: 1px solid #e5e7eb;">
                            For best results, practice daily for 15-20 minutes. Consistency is more important than long sessions.
                        </div>
                    </div>
                </div>
                
                <!-- Troubleshooting -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-tools"></i> Troubleshooting</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #ef4444;">
                            <h6><i class="fas fa-microphone-slash" style="color: #ef4444;"></i> Microphone Issues</h6>
                            <p style="color: #666; margin: 0;">Check browser permissions and ensure microphone is not muted.</p>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #ef4444;">
                            <h6><i class="fas fa-video-slash" style="color: #ef4444;"></i> Camera Issues</h6>
                            <p style="color: #666; margin: 0;">Allow camera access in browser settings and ensure good lighting.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div>
                <!-- Contact Support -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-headset"></i> Contact Support</h4>
                    <div style="background: #f0f4ff; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #6366f1;">
                        <i class="fas fa-envelope" style="color: #6366f1;"></i>
                        <strong>Email:</strong> support@amac-therapy.com
                    </div>
                    <div style="background: #f0fff4; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #22c55e;">
                        <i class="fas fa-phone" style="color: #22c55e;"></i>
                        <strong>Phone:</strong> 1-800-AMAC-HELP
                    </div>
                    <div style="background: #fffbeb; padding: 15px; border-radius: 10px; border-left: 4px solid #f59e0b;">
                        <i class="fas fa-clock" style="color: #f59e0b;"></i>
                        <strong>Hours:</strong> Mon-Fri, 9 AM - 5 PM
                    </div>
                </div>
                
                <!-- System Status -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #6366f1; margin-bottom: 20px;"><i class="fas fa-server"></i> System Status</h4>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 10px; margin-bottom: 10px;">
                        <span style="color: #333;">Speech Recognition</span>
                        <span style="background: #22c55e; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Online</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 10px; margin-bottom: 10px;">
                        <span style="color: #333;">AI Analysis</span>
                        <span style="background: #22c55e; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Online</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 10px;">
                        <span style="color: #333;">Database</span>
                        <span style="background: #22c55e; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Online</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Show test page function for feedback and help
        function showTestPage(pageId, link) {
            if (event) event.preventDefault();
            
            // Hide all pages including test pages
            document.querySelectorAll('.page').forEach(function(p) {
                p.style.display = 'none';
                p.classList.remove('active');
            });
            
            // Hide test pages
            var testFeedback = document.getElementById('test-feedback-page');
            var testHelp = document.getElementById('test-help-page');
            if (testFeedback) testFeedback.style.display = 'none';
            if (testHelp) testHelp.style.display = 'none';
            
            // Show selected test page
            var targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.style.display = 'block';
            }
            
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(function(l) {
                l.classList.remove('active');
            });
            if (link) link.classList.add('active');
        }
        
        // Navigation function - must be first
        function navTo(pageId, link) {
            if (event) event.preventDefault();
            
            // Show main-content and hide test pages
            document.querySelector('.main-content').style.display = 'block';
            var testFeedback = document.getElementById('test-feedback-page');
            var testHelp = document.getElementById('test-help-page');
            if (testFeedback) testFeedback.style.display = 'none';
            if (testHelp) testHelp.style.display = 'none';
            
            // Hide all pages
            var pages = document.querySelectorAll('.page');
            for (var i = 0; i < pages.length; i++) {
                pages[i].style.display = 'none';
                pages[i].classList.remove('active');
            }
            
            // Show target page
            var targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.style.display = 'block';
                targetPage.classList.add('active');
            }
            
            // Update nav links
            var links = document.querySelectorAll('.nav-link');
            for (var j = 0; j < links.length; j++) {
                links[j].classList.remove('active');
            }
            if (link) link.classList.add('active');
        }
        
        // Toast notification function
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'custom-toast';
            
            const icons = {
                'success': '<i class="fas fa-check-circle" style="color: #10b981; font-size: 20px;"></i>',
                'error': '<i class="fas fa-exclamation-circle" style="color: #ef4444; font-size: 20px;"></i>',
                'info': '<i class="fas fa-info-circle" style="color: #667eea; font-size: 20px;"></i>',
                'warning': '<i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 20px;"></i>'
            };
            
            toast.innerHTML = `${icons[type]}<span>${message}</span>`;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Confirm logout function
        function confirmLogout(event) {
            event.preventDefault();
            if (confirm('Are you sure you want to logout?')) {
                // Clear all user data from localStorage
                localStorage.removeItem('amac_user');
                localStorage.removeItem('amac_username');
                localStorage.removeItem('amac_token');
                localStorage.removeItem('currentUser');
                sessionStorage.clear();
                
                // Redirect to logout endpoint
                window.location.href = '/logout';
            }
        }
        
        // Global variables
        let currentSession = null;
        let currentExercise = null;
        let sessionExercises = [];
        let completedExercises = [];
        let progressChart = null;
        let monthlyChart = null;
        let sessionStartTime = null;
        
        // Translation variables
        let translationRecognition = null;
        let translationMediaRecorder = null;
        let translationStream = null;
        let isTranslationRecording = false;
        let currentTranscript = '';
        let translationHistory = [];
        let audioChunks = [];
        let videoChunks = [];
        
        // Model Configuration - Set to true when trained models are integrated
        const DYSARTHRIA_MODEL_CONFIG = {
            useTrainedAudioModel: false,  // Set to true when audio model is ready
            useTrainedVisualModel: false, // Set to true when visual/lip-reading model is ready
            useTrainedTTSModel: false,    // Set to true when TTS model is ready
            audioModelEndpoint: '/api/dysarthria/audio/recognize',
            visualModelEndpoint: '/api/dysarthria/visual/recognize',
            fusedModelEndpoint: '/api/dysarthria/multimodal/recognize', // Combined audio+visual
            ttsModelEndpoint: '/api/dysarthria/tts/synthesize'
        };
        
        // Helper function to enable translation action buttons
        function enableTranslationButtons() {
            const speakBtn = document.getElementById('speakBrowserBtn');
            const copyBtn = document.getElementById('copyTranslationBtn');
            
            if (speakBtn) speakBtn.disabled = false;
            if (copyBtn) copyBtn.disabled = false;
            
            console.log('Translation buttons enabled');
        }
        
        // Helper function to disable translation action buttons
        function disableTranslationButtons() {
            const speakBtn = document.getElementById('speakBrowserBtn');
            const copyBtn = document.getElementById('copyTranslationBtn');
            
            if (speakBtn) speakBtn.disabled = true;
            if (copyBtn) copyBtn.disabled = true;
        }
        
        // Update model status badges on page load
        function updateModelStatusBadges() {
            const audioStatus = document.getElementById('audioModelStatus');
            const visualStatus = document.getElementById('visualModelStatus');
            const ttsStatus = document.getElementById('ttsModelStatus');
            
            if (audioStatus) {
                if (DYSARTHRIA_MODEL_CONFIG.useTrainedAudioModel) {
                    audioStatus.className = 'badge bg-success';
                    audioStatus.innerHTML = '<i class="fas fa-microphone-alt me-1"></i>Audio Model: Active';
                } else {
                    audioStatus.className = 'badge bg-secondary';
                    audioStatus.innerHTML = '<i class="fas fa-microphone-alt me-1"></i>Audio Model: Pending';
                }
            }
            
            if (visualStatus) {
                if (DYSARTHRIA_MODEL_CONFIG.useTrainedVisualModel) {
                    visualStatus.className = 'badge bg-success';
                    visualStatus.innerHTML = '<i class="fas fa-video me-1"></i>Visual Model: Active';
                } else {
                    visualStatus.className = 'badge bg-secondary';
                    visualStatus.innerHTML = '<i class="fas fa-video me-1"></i>Visual Model: Pending';
                }
            }
            
            if (ttsStatus) {
                if (DYSARTHRIA_MODEL_CONFIG.useTrainedTTSModel) {
                    ttsStatus.className = 'badge bg-success';
                    ttsStatus.innerHTML = '<i class="fas fa-volume-up me-1"></i>TTS Model: Active';
                } else {
                    ttsStatus.className = 'badge bg-secondary';
                    ttsStatus.innerHTML = '<i class="fas fa-volume-up me-1"></i>TTS Model: Pending';
                }
            }
        }
        
        // Check Source Language and show Coming Soon popup for non-English
        function checkSourceLanguage(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const isComingSoon = selectedOption.getAttribute('data-coming-soon') === 'true';
            
            if (isComingSoon) {
                // Show Coming Soon modal
                showComingSoonModal(selectedOption.text.replace(' (Coming Soon)', ''));
                
                // Reset to English (US)
                selectElement.value = 'en-US';
            }
        }
        
        // Check Target Language and show Coming Soon popup for non-English
        function checkTargetLanguage(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const isComingSoon = selectedOption.getAttribute('data-coming-soon') === 'true';
            
            if (isComingSoon) {
                // Get the language name
                let languageName = selectedOption.text;
                // Clean up the name
                languageName = languageName.replace(' (Coming Soon)', '').replace(' (Clarify)', '');
                
                // Show Coming Soon modal
                showComingSoonModal(languageName);
                
                // Reset to English (Clarify)
                selectElement.value = 'en';
            } else {
                // Valid selection - trigger translation if there's text
                if (currentTranscript && currentTranscript.trim()) {
                    translateText();
                }
            }
        }
        
        // Show Coming Soon Modal
        function showComingSoonModal(languageName) {
            // Create modal if not exists
            let modal = document.getElementById('comingSoonModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'comingSoonModal';
                modal.innerHTML = `
                    <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                        <div class="modal-content" style="background: white; border-radius: 20px; padding: 40px; max-width: 450px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: modalPop 0.3s ease;">
                            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                                <i class="fas fa-clock fa-2x" style="color: white;"></i>
                            </div>
                            <h3 style="color: #1F2A44; margin-bottom: 15px; font-weight: 700;">Coming Soon!</h3>
                            <p style="color: #5A6B8A; font-size: 16px; line-height: 1.6;" id="comingSoonMessage">
                                <strong id="comingSoonLanguage"></strong> speech recognition model is currently under development.
                            </p>
                            <p style="color: #5A6B8A; font-size: 14px; margin-top: 10px;">
                                <i class="fas fa-info-circle me-1"></i> Currently, only <strong>English</strong> is supported for dysarthria speech recognition.
                            </p>
                            <button onclick="closeComingSoonModal()" style="margin-top: 20px; padding: 12px 40px; background: linear-gradient(135deg, #5B8DEF, #4A7BD9); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                <i class="fas fa-check me-2"></i>Got it!
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Add animation style if not exists
                if (!document.getElementById('modalAnimationStyle')) {
                    const style = document.createElement('style');
                    style.id = 'modalAnimationStyle';
                    style.textContent = `
                        @keyframes modalPop {
                            from { transform: scale(0.8); opacity: 0; }
                            to { transform: scale(1); opacity: 1; }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
            
            document.getElementById('comingSoonLanguage').textContent = languageName;
            modal.style.display = 'block';
        }
        
        // Close Coming Soon Modal
        function closeComingSoonModal() {
            const modal = document.getElementById('comingSoonModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // ============================================================
        // TRANSLATION HISTORY PERSISTENCE (Save/Load for Users)
        // ============================================================
        
        // Get current username from session
        function getCurrentUsername() {
            return localStorage.getItem('amacUsername') || sessionStorage.getItem('amacUsername') || 'default_user';
        }
        
        // Save translation history to localStorage
        function saveTranslationHistory() {
            const username = getCurrentUsername();
            const storageKey = `amac_translation_history_${username}`;
            localStorage.setItem(storageKey, JSON.stringify(translationHistory));
        }
        
        // Load translation history for current user
        function loadTranslationHistory() {
            const username = getCurrentUsername();
            const storageKey = `amac_translation_history_${username}`;
            const saved = localStorage.getItem(storageKey);
            
            if (saved) {
                try {
                    translationHistory = JSON.parse(saved);
                    updateTranslationHistoryUI();
                    console.log(`Loaded ${translationHistory.length} translation history items for user: ${username}`);
                } catch (e) {
                    console.error('Error loading translation history:', e);
                    translationHistory = [];
                }
            } else {
                // New user - start with empty history
                translationHistory = [];
                console.log(`New user: ${username} - starting with fresh translation history`);
            }
        }
        
        // Clear translation history for current user
        function clearTranslationHistoryStorage() {
            const username = getCurrentUsername();
            const storageKey = `amac_translation_history_${username}`;
            localStorage.removeItem(storageKey);
            translationHistory = [];
            updateTranslationHistoryUI();
            showToast('Translation history cleared!', 'success');
        }
        
        // ============================================================
        // DYSARTHRIA SPEECH RECOGNITION - TRAINED MODEL INTEGRATION
        // ============================================================
        
        /**
         * Process audio with trained dysarthria speech recognition model
         * @param {Blob} audioBlob - Audio data from recording
         * @returns {Promise<string>} - Recognized text
         */
        async function recognizeWithAudioModel(audioBlob) {
            // TODO: Integrate your trained audio model here
            // Example implementation:
            /*
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.webm');
            formData.append('language', document.getElementById('sourceLanguage').value);
            
            const response = await fetch(DYSARTHRIA_MODEL_CONFIG.audioModelEndpoint, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                return result.text;
            }
            throw new Error('Audio model recognition failed');
            */
            
            console.log('Audio model placeholder - integrate your trained model here');
            return null;
        }
        
        /**
         * Process video frames with trained visual/lip-reading model
         * @param {Blob} videoBlob - Video data from recording
         * @returns {Promise<string>} - Recognized text from lip movements
         */
        async function recognizeWithVisualModel(videoBlob) {
            // TODO: Integrate your trained visual/lip-reading model here
            // Example implementation:
            /*
            const formData = new FormData();
            formData.append('video', videoBlob, 'recording.webm');
            formData.append('language', document.getElementById('sourceLanguage').value);
            
            const response = await fetch(DYSARTHRIA_MODEL_CONFIG.visualModelEndpoint, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                return result.text;
            }
            throw new Error('Visual model recognition failed');
            */
            
            console.log('Visual model placeholder - integrate your trained model here');
            return null;
        }
        
        /**
         * Process audio+video with multimodal fusion model
         * Combines audio and visual cues for better dysarthria recognition
         * @param {Blob} audioBlob - Audio data
         * @param {Blob} videoBlob - Video data
         * @returns {Promise<string>} - Fused recognition result
         */
        async function recognizeWithMultimodalModel(audioBlob, videoBlob) {
            // TODO: Integrate your multimodal (audio + visual) fusion model here
            // Example implementation:
            /*
            const formData = new FormData();
            formData.append('audio', audioBlob, 'audio.webm');
            formData.append('video', videoBlob, 'video.webm');
            formData.append('language', document.getElementById('sourceLanguage').value);
            
            const response = await fetch(DYSARTHRIA_MODEL_CONFIG.fusedModelEndpoint, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                return {
                    text: result.text,
                    confidence: result.confidence,
                    audioContribution: result.audio_weight,
                    visualContribution: result.visual_weight
                };
            }
            throw new Error('Multimodal recognition failed');
            */
            
            console.log('Multimodal model placeholder - integrate your trained fusion model here');
            return null;
        }
        
        /**
         * Main dysarthria speech recognition function
         * Routes to appropriate model based on configuration
         */
        async function processDysarthriaSpeech(audioBlob, videoBlob) {
            let recognizedText = null;
            
            try {
                // Check which models to use
                if (DYSARTHRIA_MODEL_CONFIG.useTrainedAudioModel && DYSARTHRIA_MODEL_CONFIG.useTrainedVisualModel) {
                    // Use multimodal fusion for best accuracy
                    const result = await recognizeWithMultimodalModel(audioBlob, videoBlob);
                    recognizedText = result?.text || result;
                    if (recognizedText) {
                        showToast('🎯 Recognized using Audio+Visual Model', 'success');
                    }
                } else if (DYSARTHRIA_MODEL_CONFIG.useTrainedAudioModel) {
                    // Use audio-only model
                    recognizedText = await recognizeWithAudioModel(audioBlob);
                    if (recognizedText) {
                        showToast('🎤 Recognized using Audio Model', 'success');
                    }
                } else if (DYSARTHRIA_MODEL_CONFIG.useTrainedVisualModel) {
                    // Use visual-only model (lip-reading)
                    recognizedText = await recognizeWithVisualModel(videoBlob);
                    if (recognizedText) {
                        showToast('👁️ Recognized using Visual Model', 'success');
                    }
                }
                
                return recognizedText;
            } catch (error) {
                console.error('Dysarthria model error:', error);
                showToast('Model error, falling back to browser recognition', 'warning');
                return null;
            }
        }
        
        // ============================================================
        // END DYSARTHRIA MODEL INTEGRATION
        // ============================================================
        
        // Initialize Speech Recognition for Translation
        function initTranslationRecognition() {
            console.log('Initializing speech recognition...');
            
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                translationRecognition = new SpeechRecognition();
                
                translationRecognition.continuous = true;
                translationRecognition.interimResults = true;
                translationRecognition.lang = 'en-US';
                translationRecognition.maxAlternatives = 1;
                
                translationRecognition.onstart = function() {
                    console.log('✓ Speech recognition started successfully');
                    document.getElementById('translationStatus').textContent = 'Listening...';
                    document.getElementById('translationStatus').className = 'badge bg-success';
                    showToast('🎤 Listening... Speak now!', 'success');
                };
                
                translationRecognition.onaudiostart = function() {
                    console.log('Audio capturing started');
                };
                
                translationRecognition.onsoundstart = function() {
                    console.log('Sound detected');
                };
                
                translationRecognition.onspeechstart = function() {
                    console.log('Speech detected');
                };
                
                translationRecognition.onresult = function(event) {
                    console.log('Speech result received:', event.results);
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        const confidence = event.results[i][0].confidence;
                        console.log(`Result ${i}: "${transcript}" (confidence: ${confidence}, final: ${event.results[i].isFinal})`);
                        
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    if (finalTranscript) {
                        currentTranscript += finalTranscript;
                        console.log('Final transcript updated:', currentTranscript);
                    }
                    
                    // Display the transcript
                    const displayText = currentTranscript + '<span style="color: #94a3b8; font-style: italic;">' + interimTranscript + '</span>';
                    document.getElementById('originalSpeechText').innerHTML = displayText || '<span class="text-muted">Your speech will appear here...</span>';
                    
                    // Auto-translate if enabled and we have final text
                    if (document.getElementById('autoTranslate')?.checked && finalTranscript) {
                        translateText();
                    }
                };
                
                translationRecognition.onspeechend = function() {
                    console.log('Speech ended');
                };
                
                translationRecognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error, event.message);
                    
                    if (event.error === 'no-speech') {
                        console.log('No speech detected - this is normal if user is silent');
                    } else if (event.error === 'audio-capture') {
                        showToast('Microphone not accessible. Please check permissions.', 'error');
                    } else if (event.error === 'not-allowed') {
                        showToast('Microphone permission denied. Please allow microphone access.', 'error');
                    } else if (event.error === 'network') {
                        showToast('Network error. Speech recognition requires internet connection.', 'error');
                    } else {
                        showToast('Speech recognition error: ' + event.error, 'error');
                    }
                };
                
                translationRecognition.onend = function() {
                    console.log('Speech recognition ended, isTranslationRecording:', isTranslationRecording);
                    
                    if (isTranslationRecording) {
                        // Restart if still recording (for continuous mode)
                        console.log('Restarting speech recognition...');
                        setTimeout(() => {
                            try {
                                translationRecognition.start();
                            } catch (e) {
                                console.log('Recognition restart failed:', e);
                            }
                        }, 100);
                    } else {
                        document.getElementById('translationStatus').textContent = 'Ready to Record';
                        document.getElementById('translationStatus').className = 'badge bg-info';
                    }
                };
                
                console.log('Speech recognition initialized successfully');
                return true;
            } else {
                console.error('Speech recognition not supported');
                showToast('Speech recognition is not supported in this browser. Please use Chrome or Edge.', 'error');
                return false;
            }
        }
        
        // Setup Translation Camera
        async function setupTranslationCamera() {
            try {
                translationStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 }, 
                    audio: true 
                });
                
                const videoElement = document.getElementById('translationVideoPreview');
                if (videoElement) {
                    videoElement.srcObject = translationStream;
                }
                
                return true;
            } catch (error) {
                console.error('Error accessing camera for translation:', error);
                return false;
            }
        }
        
        // Start Translation Recording
        async function startTranslationRecording() {
            console.log('Starting translation recording...');
            
            // Setup camera if not already done
            if (!translationStream) {
                console.log('Setting up camera...');
                const cameraReady = await setupTranslationCamera();
                if (!cameraReady) {
                    showToast('Could not access camera/microphone. Please check permissions.', 'error');
                    return;
                }
                console.log('Camera ready');
            }
            
            // Initialize speech recognition
            if (!translationRecognition) {
                console.log('Initializing speech recognition...');
                if (!initTranslationRecognition()) {
                    showToast('Speech recognition not available', 'error');
                    return;
                }
            }
            
            // Reset transcript and chunks
            currentTranscript = '';
            audioChunks = [];
            videoChunks = [];
            document.getElementById('originalSpeechText').innerHTML = '<span class="text-muted" style="animation: pulse 1s infinite;">🎤 Listening... Speak now!</span>';
            document.getElementById('translatedText').innerHTML = '<span class="text-muted">Translation will appear here...</span>';
            
            // Start recording
            isTranslationRecording = true;
            
            // Start MediaRecorder to capture audio/video for trained models (if enabled)
            if (translationStream && (DYSARTHRIA_MODEL_CONFIG.useTrainedAudioModel || DYSARTHRIA_MODEL_CONFIG.useTrainedVisualModel)) {
                try {
                    translationMediaRecorder = new MediaRecorder(translationStream, {
                        mimeType: 'video/webm;codecs=vp9,opus'
                    });
                    
                    translationMediaRecorder.ondataavailable = function(event) {
                        if (event.data.size > 0) {
                            videoChunks.push(event.data);
                        }
                    };
                    
                    translationMediaRecorder.start(1000);
                    console.log('MediaRecorder started');
                } catch (e) {
                    console.log('MediaRecorder setup failed:', e);
                }
            }
            
            // Start browser speech recognition
            try {
                // Stop any existing recognition first
                try {
                    translationRecognition.stop();
                } catch (e) { /* ignore */ }
                
                // Wait a moment then start
                setTimeout(() => {
                    try {
                        translationRecognition.start();
                        console.log('Speech recognition started');
                    } catch (e) {
                        console.error('Failed to start speech recognition:', e);
                        showToast('Failed to start speech recognition. Please refresh and try again.', 'error');
                    }
                }, 100);
            } catch (e) {
                console.error('Recognition error:', e);
            }
            
            // Update UI
            document.getElementById('startTranslationRecordBtn').style.display = 'none';
            document.getElementById('stopTranslationRecordBtn').style.display = 'inline-block';
            document.getElementById('translationRecordingIndicator').style.display = 'flex';
            document.getElementById('translationInstructions').innerHTML = '<i class="fas fa-circle text-danger me-2" style="animation: pulse 1s infinite;"></i>Recording... Speak now!';
            
            showToast('🎤 Recording started. Speak clearly into your microphone!', 'success');
        }
        
        // Stop Translation Recording
        async function stopTranslationRecording() {
            isTranslationRecording = false;
            
            // Stop browser speech recognition
            if (translationRecognition) {
                translationRecognition.stop();
            }
            
            // Stop MediaRecorder and process with trained models
            if (translationMediaRecorder && translationMediaRecorder.state !== 'inactive') {
                translationMediaRecorder.stop();
                
                // Wait for final data
                await new Promise(resolve => {
                    translationMediaRecorder.onstop = resolve;
                });
                
                // Process with trained models if enabled
                if (DYSARTHRIA_MODEL_CONFIG.useTrainedAudioModel || DYSARTHRIA_MODEL_CONFIG.useTrainedVisualModel) {
                    document.getElementById('translationStatus').textContent = 'Processing with AI...';
                    document.getElementById('translationStatus').className = 'badge bg-warning';
                    
                    const videoBlob = new Blob(videoChunks, { type: 'video/webm' });
                    
                    // Extract audio from video for audio model
                    const audioBlob = videoBlob; // In practice, you'd extract audio track
                    
                    try {
                        const modelResult = await processDysarthriaSpeech(audioBlob, videoBlob);
                        
                        if (modelResult) {
                            // Use model result instead of browser recognition
                            currentTranscript = modelResult;
                            document.getElementById('originalSpeechText').innerHTML = `
                                <div style="padding: 8px; background: rgba(91, 141, 239, 0.1); border-radius: 8px; border-left: 3px solid var(--primary-color); margin-bottom: 10px;">
                                    <small style="color: var(--primary-color); font-weight: 600;">
                                        <i class="fas fa-robot me-1"></i>AI Model Recognition
                                    </small>
                                </div>
                                ${modelResult}
                            `;
                        }
                    } catch (error) {
                        console.error('Model processing error:', error);
                        showToast('AI Model processing failed, using browser recognition', 'warning');
                    }
                }
            }
            
            // Update UI
            document.getElementById('startTranslationRecordBtn').style.display = 'inline-block';
            document.getElementById('stopTranslationRecordBtn').style.display = 'none';
            document.getElementById('translationRecordingIndicator').style.display = 'none';
            document.getElementById('translationInstructions').innerHTML = '<i class="fas fa-info-circle me-2"></i>Click the microphone button and start speaking. Your speech will be recognized and translated.';
            document.getElementById('translationStatus').textContent = 'Ready to Record';
            document.getElementById('translationStatus').className = 'badge bg-info';
            
            // Check if we got any transcript
            console.log('Final transcript:', currentTranscript);
            
            if (currentTranscript.trim()) {
                translateText();
                showToast('Recording stopped. Processing...', 'info');
            } else {
                document.getElementById('originalSpeechText').innerHTML = '<span class="text-muted">No speech detected. Please try again and speak clearly into your microphone.</span>';
                showToast('No speech detected. Make sure your microphone is working and speak clearly.', 'warning');
            }
        }
        
        // Translate Text using API
        async function translateText() {
            const text = currentTranscript.trim();
            if (!text) {
                return;
            }
            
            const targetLangValue = document.getElementById('targetLanguage').value;
            const sourceLang = document.getElementById('sourceLanguage').value.split('-')[0];
            
            // Check if it's same-language mode (for dysarthria speech clarity)
            const isSameLanguage = !targetLangValue.includes('-trans');
            const targetLang = targetLangValue.replace('-trans', '');
            
            document.getElementById('translatedText').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>' + (isSameLanguage ? 'Processing speech...' : 'Translating...');
            
            // For same language (dysarthria mode) - display the clarified text directly
            if (isSameLanguage && sourceLang === targetLang) {
                // Same language mode - show the transcribed text as clarified speech
                const clarifiedText = text;
                document.getElementById('translatedText').innerHTML = `<div style="padding: 10px; background: rgba(126, 209, 178, 0.1); border-radius: 10px; border-left: 4px solid var(--success-color);">
                    <small style="color: var(--success-color); font-weight: 600;"><i class="fas fa-check-circle me-1"></i>Clarified Speech</small>
                    <p class="clarified-text" style="margin: 8px 0 0 0; font-size: 18px;">${clarifiedText}</p>
                </div>`;
                
                // Enable buttons using helper function
                enableTranslationButtons();
                
                // Add to history with clarify label
                addToTranslationHistory(text, clarifiedText, targetLang + '-clarify');
                return;
            }
            
            try {
                // Using MyMemory API for translation
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.responseData && data.responseData.translatedText) {
                        const translatedText = data.responseData.translatedText;
                        
                        // For same language with different source - still show as clarified
                        if (isSameLanguage) {
                            document.getElementById('translatedText').innerHTML = `<div style="padding: 10px; background: rgba(126, 209, 178, 0.1); border-radius: 10px; border-left: 4px solid var(--success-color);">
                                <small style="color: var(--success-color); font-weight: 600;"><i class="fas fa-check-circle me-1"></i>Clarified Speech (${getLangName(targetLang)})</small>
                                <p class="clarified-text" style="margin: 8px 0 0 0; font-size: 18px;">${translatedText}</p>
                            </div>`;
                            addToTranslationHistory(text, translatedText, targetLang + '-clarify');
                        } else {
                            document.getElementById('translatedText').innerHTML = `<p class="translated-text" style="margin: 0; font-size: 16px;">${translatedText}</p>`;
                            addToTranslationHistory(text, translatedText, targetLang);
                        }
                        
                        // Enable buttons using helper function
                        enableTranslationButtons();
                    } else {
                        throw new Error('Translation failed');
                    }
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.error('Translation error:', error);
                // Fallback: show original text with note
                document.getElementById('translatedText').innerHTML = `<span class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Translation service unavailable. Original text:</span><br><p class="fallback-text">${text}</p>`;
                enableTranslationButtons();
            }
        }
        
        // Helper function to get language name
        function getLangName(code) {
            const names = {
                'en': 'English', 'es': 'Spanish', 'fr': 'French', 'de': 'German',
                'hi': 'Hindi', 'te': 'Telugu', 'ta': 'Tamil', 'zh': 'Chinese',
                'ja': 'Japanese', 'ko': 'Korean', 'ar': 'Arabic', 'pt': 'Portuguese', 'ru': 'Russian'
            };
            return names[code] || code;
        }
        
        // Add to Translation History
        function addToTranslationHistory(original, translated, targetLang) {
            const isClarifyMode = targetLang.includes('-clarify');
            const actualLang = targetLang.replace('-clarify', '');
            
            const langNames = {
                'en': 'English', 'es': 'Spanish', 'fr': 'French', 'de': 'German', 'hi': 'Hindi',
                'te': 'Telugu', 'ta': 'Tamil', 'zh': 'Chinese', 'ja': 'Japanese',
                'ko': 'Korean', 'ar': 'Arabic', 'pt': 'Portuguese', 'ru': 'Russian'
            };
            
            const displayLang = isClarifyMode ? `${langNames[actualLang] || actualLang} (Clarified)` : (langNames[actualLang] || actualLang);
            
            const historyItem = {
                original: original.substring(0, 50) + (original.length > 50 ? '...' : ''),
                translated: translated.substring(0, 50) + (translated.length > 50 ? '...' : ''),
                fullOriginal: original,  // Store full text for loading
                fullTranslated: translated,
                language: displayLang,
                timestamp: new Date().toLocaleTimeString(),
                date: new Date().toLocaleDateString()
            };
            
            translationHistory.unshift(historyItem);
            if (translationHistory.length > 20) {  // Keep more history
                translationHistory.pop();
            }
            
            updateTranslationHistoryUI();
            
            // Save to localStorage for persistence
            saveTranslationHistory();
        }
        
        // Update Translation History UI
        function updateTranslationHistoryUI() {
            const container = document.getElementById('translationHistory');
            if (!container) return;
            
            if (translationHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-clock fa-2x mb-3" style="color: #d1d5db;"></i>
                        <p class="text-muted mb-0">No translations yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = translationHistory.map((item, index) => `
                <div class="p-3 mb-2" style="background: linear-gradient(135deg, rgba(91, 141, 239, 0.05), rgba(126, 209, 178, 0.03)); border-radius: 12px; cursor: pointer; transition: all 0.2s;" onclick="loadHistoryItem(${index})" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <small class="text-muted">${item.date ? item.date + ' ' : ''}${item.timestamp}</small>
                        <span class="badge bg-primary" style="font-size: 10px;">${item.language}</span>
                    </div>
                    <div style="font-size: 13px; color: #334155;">"${item.original}"</div>
                    <div style="font-size: 12px; color: var(--success-color); margin-top: 4px;">→ "${item.translated}"</div>
                </div>
            `).join('');
        }
        
        // Load History Item
        function loadHistoryItem(index) {
            const item = translationHistory[index];
            if (item) {
                // Use full text if available, otherwise use truncated
                const originalText = item.fullOriginal || item.original;
                const translatedText = item.fullTranslated || item.translated;
                
                document.getElementById('originalSpeechText').innerHTML = originalText;
                document.getElementById('translatedText').innerHTML = `<p class="history-text" style="margin: 0; font-size: 16px;">${translatedText}</p>`;
                
                // Enable buttons using helper function
                enableTranslationButtons();
                
                // Update current transcript for potential re-translation
                currentTranscript = originalText;
                
                showToast('Loaded from history', 'info');
            }
        }
        
        // Speak Translation using Trained AI TTS Model
        async function speakTranslation() {
            let text = document.getElementById('translatedText').innerText;
            if (!text || text.includes('Translation will appear')) {
                showToast('No translation to speak', 'warning');
                return;
            }
            
            // Clean up the text - remove labels like "Clarified Speech"
            text = text.replace(/Clarified Speech(\s*\([^)]+\))?/gi, '').trim();
            
            if (!text) {
                showToast('No text to speak', 'warning');
                return;
            }
            
            const targetLangValue = document.getElementById('targetLanguage').value;
            const targetLang = targetLangValue.replace('-trans', '');
            
            // Check if trained TTS model is enabled
            if (DYSARTHRIA_MODEL_CONFIG.useTrainedTTSModel) {
                try {
                    showToast('🤖 Generating clear speech with AI Model...', 'info');
                    
                    const response = await fetch(DYSARTHRIA_MODEL_CONFIG.ttsModelEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            text: text, 
                            language: targetLang,
                            voice_style: 'clear',  // For dysarthria patients
                            speed: 0.9  // Slightly slower for clarity
                        })
                    });
                    
                    if (response.ok) {
                        const audioBlob = await response.blob();
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                        audio.play();
                        showToast('🔊 Playing AI-generated clear speech', 'success');
                        return;
                    } else {
                        throw new Error('TTS model request failed');
                    }
                } catch (error) {
                    console.error('AI TTS error:', error);
                    showToast('AI TTS failed, using browser TTS', 'warning');
                }
            } else {
                // Show message that model will be integrated
                showToast('🤖 AI TTS Model will be integrated soon. Using browser TTS...', 'info');
            }
            
            // Fallback to browser TTS
            speakWithBrowserTTS();
        }
        
        // Speak with Browser Text-to-Speech (standard)
        function speakWithBrowserTTS() {
            let text = document.getElementById('translatedText').innerText;
            if (!text || text.includes('Translation will appear')) {
                showToast('No translation to speak', 'warning');
                return;
            }
            
            // Clean up the text - remove labels like "Clarified Speech"
            text = text.replace(/Clarified Speech(\s*\([^)]+\))?/gi, '').trim();
            
            if (!text) {
                showToast('No text to speak', 'warning');
                return;
            }
            
            // Cancel any ongoing speech
            speechSynthesis.cancel();
            
            const targetLangValue = document.getElementById('targetLanguage').value;
            const targetLang = targetLangValue.replace('-trans', '');
            const langMap = {
                'en': 'en-US', 'es': 'es-ES', 'fr': 'fr-FR', 'de': 'de-DE', 'hi': 'hi-IN',
                'te': 'te-IN', 'ta': 'ta-IN', 'zh': 'zh-CN', 'ja': 'ja-JP',
                'ko': 'ko-KR', 'ar': 'ar-SA', 'pt': 'pt-BR', 'ru': 'ru-RU'
            };
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = langMap[targetLang] || 'en-US';
            utterance.rate = 0.85;  // Slower for clarity
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            utterance.onstart = () => {
                showToast('🔊 Speaking...', 'info');
            };
            
            utterance.onend = () => {
                showToast('✓ Finished speaking', 'success');
            };
            
            utterance.onerror = (event) => {
                console.error('Speech error:', event);
                showToast('Speech error: ' + event.error, 'error');
            };
            
            speechSynthesis.speak(utterance);
        }
        
        // Copy Translation
        function copyTranslation() {
            let text = document.getElementById('translatedText').innerText;
            if (!text || text.includes('Translation will appear')) {
                showToast('No translation to copy', 'warning');
                return;
            }
            
            // Clean up the text - remove labels like "Clarified Speech"
            text = text.replace(/Clarified Speech(\s*\([^)]+\))?/gi, '').trim();
            
            if (!text) {
                showToast('No text to copy', 'warning');
                return;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('✓ Copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('✓ Copied to clipboard!', 'success');
                } catch (e) {
                    showToast('Failed to copy', 'error');
                }
                document.body.removeChild(textArea);
            });
        }
        
        // Clear Translation
        function clearTranslation() {
            currentTranscript = '';
            document.getElementById('originalSpeechText').innerHTML = '<span class="text-muted">Your speech will appear here...</span>';
            document.getElementById('translatedText').innerHTML = '<span class="text-muted">Translation will appear here...</span>';
            disableTranslationButtons();
            showToast('Cleared!', 'info');
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('AMAC Dashboard Initializing...');
            
            // Load saved exercises from localStorage
            loadSavedExercises();
            
            // Setup camera
            await setupCamera();
            
            // Load user profile
            await loadUserProfile();
            
            // Load completed sessions from API
            await loadCompletedSessions();
            
            // Initialize charts
            initializeCharts();
            
            // Update model status badges for Translation page
            updateModelStatusBadges();
            
            // Load translation history for current user (existing users get saved history)
            loadTranslationHistory();
            
            // Setup export buttons
            var pdfBtn = document.getElementById('pdfDownloadBtn');
            var csvBtn = document.getElementById('csvExportBtn');
            
            if (pdfBtn) {
                pdfBtn.onclick = function() {
                    console.log('PDF button clicked');
                    downloadPDFReport();
                };
            }
            
            if (csvBtn) {
                csvBtn.onclick = function() {
                    console.log('CSV button clicked');
                    exportCSVData();
                };
            }
            
            console.log('Dashboard Ready!');
        });
        
        // Save completed exercises to localStorage AND to database
        async function saveCompletedExercises() {
            const username = localStorage.getItem('amacUsername') || sessionStorage.getItem('amacUsername') || 'default';
            const key = `amac_exercises_${username}`;
            
            // Save to localStorage
            try {
                localStorage.setItem(key, JSON.stringify({
                    exercises: completedExercises,
                    lastUpdated: new Date().toISOString()
                }));
            } catch (error) {
                console.error('Error saving exercises to localStorage:', error);
            }
            
            // Save to database via API
            try {
                const response = await fetch('/api/therapy/save-progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        exercises: completedExercises,
                        duration_minutes: Math.round((Date.now() - sessionStartTime) / 60000) || 1
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Progress saved to database:', data);
                }
            } catch (error) {
                console.error('Error saving to database:', error);
            }
        }
        
        // Load saved exercises from localStorage
        function loadSavedExercises() {
            const username = localStorage.getItem('amacUsername') || sessionStorage.getItem('amacUsername') || 'default';
            const key = `amac_exercises_${username}`;
            try {
                const saved = localStorage.getItem(key);
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.exercises && Array.isArray(data.exercises)) {
                        completedExercises = data.exercises;
                        console.log('Loaded', completedExercises.length, 'saved exercises');
                    }
                }
            } catch (error) {
                console.error('Error loading exercises:', error);
            }
        }
        
        // Load completed sessions from API
        async function loadCompletedSessions() {
            try {
                const username = localStorage.getItem('amacUsername') || sessionStorage.getItem('amacUsername') || 'test_user';
                const response = await fetch(`/api/therapy/sessions?user_id=${encodeURIComponent(username)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.sessions && data.sessions.length > 0) {
                        // Update recent activity with API data
                        updateRecentActivityFromAPI(data.sessions);
                    }
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }
        
        // Update recent activity section with API data
        function updateRecentActivityFromAPI(sessions) {
            const recentActivityDiv = document.getElementById('recentActivity');
            if (!recentActivityDiv) return;
            
            let html = '';
            const recentSessions = sessions.slice(-5).reverse(); // Last 5 sessions
            
            recentSessions.forEach(function(session) {
                var sessionDate = new Date(session.date || Date.now());
                var dateStr = sessionDate.toLocaleDateString();
                var isToday = sessionDate.toDateString() === new Date().toDateString();
                var dateLabel = isToday ? 'Today' : dateStr;
                var avgScore = (session.average_score !== undefined && session.average_score !== null) ? session.average_score.toFixed(1) : '0.0';
                var exercisesCompleted = session.exercises_completed || 0;
                
                html += '<div class="exercise-card">' +
                    '<div class="d-flex justify-content-between">' +
                    '<div>' +
                    '<strong>Session: ' + dateLabel + '</strong>' +
                    '<p class="mb-1">Completed ' + exercisesCompleted + ' exercises</p>' +
                    '<small class="text-muted">Avg Score: ' + avgScore + '/100</small>' +
                    '</div>' +
                    '<span class="badge bg-success">Completed</span>' +
                    '</div>' +
                    '</div>';
            });
            
            if (html) {
                recentActivityDiv.innerHTML = html;
            }
        }
        
        // Page navigation
        function showPage(pageId, event) {
            // Prevent default link behavior
            if (event) {
                event.preventDefault();
            }
            
            // Get all pages
            var allPages = document.querySelectorAll('.page');
            var i;
            
            // Hide all pages
            for (i = 0; i < allPages.length; i++) {
                allPages[i].style.display = 'none';
                allPages[i].classList.remove('active');
            }
            
            // Show selected page
            var targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.style.display = 'block';
                targetPage.classList.add('active');
            }
            
            // Update active nav link
            var allLinks = document.querySelectorAll('.nav-link');
            for (i = 0; i < allLinks.length; i++) {
                allLinks[i].classList.remove('active');
                var onclick = allLinks[i].getAttribute('onclick');
                if (onclick && onclick.indexOf(pageId) !== -1) {
                    allLinks[i].classList.add('active');
                }
            }
            
            // Special handling for each page
            if (pageId === 'progress') {
                updateProgressCharts();
            }
            
            if (pageId === 'feedback') {
                loadOverallFeedback();
            }
        }
        
        // Load overall feedback data
        function loadOverallFeedback() {
            console.log('Loading overall feedback...');
            
            // Calculate actual scores from completed exercises
            var totalScore = 0;
            var count = 0;
            
            if (completedExercises && completedExercises.length > 0) {
                for (var i = 0; i < completedExercises.length; i++) {
                    totalScore += completedExercises[i].score;
                    count++;
                }
            }
            
            var avgScore = count > 0 ? Math.round(totalScore / count) : 72;
            
            // Update the clarity score display
            var scoreDisplay = document.querySelector('#feedback .score-display');
            if (scoreDisplay) {
                scoreDisplay.textContent = avgScore;
            }
            
            // Update the progress bar
            var progressBar = document.querySelector('#feedback .progress-bar');
            if (progressBar) {
                progressBar.style.width = avgScore + '%';
            }
            
            // Update "out of 100" text
            var outOf100 = document.querySelector('#feedback .text-muted.mt-2');
            if (outOf100 && outOf100.textContent.includes('out of')) {
                outOf100.textContent = 'out of 100';
            }
            
            console.log('Feedback page loaded with score:', avgScore);
        }
        
        // Setup camera
        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 320, height: 240 },
                    audio: true
                });
                
                document.getElementById('videoPreview').srcObject = stream;
                document.getElementById('cameraStatus').textContent = 'Camera active';
                
            } catch (err) {
                console.error('Camera error:', err);
                document.getElementById('cameraStatus').textContent = 'Camera access needed';
                document.getElementById('cameraStatus').className = 'text-danger';
            }
        }
        
        // Load user profile
        async function loadUserProfile() {
            try {
                const username = localStorage.getItem('amacUsername') || sessionStorage.getItem('amacUsername') || 'test_user';
                const response = await fetch(`/api/user/profile?username=${encodeURIComponent(username)}`);
                const data = await response.json();
                
                // Update dashboard
                document.getElementById('userName').textContent = data.name || 'Patient';
                document.getElementById('sidebarUserName').textContent = data.name || 'Patient';
                document.getElementById('impairmentLevel').textContent = data.impairment_level || 'Moderate';
                document.getElementById('sidebarUserLevel').textContent = data.impairment_level || 'Moderate';
                document.getElementById('totalSessions').textContent = data.total_sessions || 0;
                document.getElementById('dayStreak').textContent = data.day_streak || 0;
                
                // Load progress data
                const progressResponse = await fetch(`/api/user/progress?username=${encodeURIComponent(username)}`);
                if (progressResponse.ok) {
                    const progressData = await progressResponse.json();
                    
                    // Check if user is NEW (no sessions completed)
                    const isNewUser = (progressData.total_sessions === 0 || progressData.total_sessions === undefined);
                    
                    if (isNewUser) {
                        // Show welcome/onboarding for new users
                        showNewUserWelcome(data.name || 'Patient');
                    } else {
                        // Show real data for existing users
                        hideNewUserWelcome();
                        document.getElementById('bestScore').textContent = progressData.best_score || 0;
                        document.getElementById('avgScore').textContent = Math.round(progressData.average_clarity || 0);
                        
                        // Update Progress Page statistics
                        updateProgressPageStats(progressData);
                        
                        // Update Feedback Page
                        updateFeedbackPageStats(progressData);
                        
                        // Update Milestones
                        updateMilestones(progressData);
                        
                        // Update Charts with real data
                        updateChartsWithData(progressData);
                    }
                }
                
                // Update recent activity with saved exercises
                updateRecentActivityFromSavedExercises();
                
            } catch (error) {
                console.error('Profile error:', error);
            }
        }
        
        // Show welcome message for new users
        function showNewUserWelcome(userName) {
            // Set stats to show "Start your journey" state
            document.getElementById('bestScore').textContent = '--';
            document.getElementById('avgScore').textContent = '--';
            
            // Update Recent Activity to show welcome message
            const recentActivityDiv = document.getElementById('recentActivity');
            if (recentActivityDiv) {
                recentActivityDiv.innerHTML = `
                    <div class="text-center p-4" style="background: linear-gradient(135deg, rgba(91, 141, 239, 0.08), rgba(126, 209, 178, 0.05)); border-radius: 16px;">
                        <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-hand-sparkles" style="font-size: 32px; color: white;"></i>
                        </div>
                        <h4 style="color: var(--text-color); font-weight: 700; margin-bottom: 10px;">Welcome, ${userName}! 🎉</h4>
                        <p style="color: var(--text-light); margin-bottom: 20px;">This is your first time here. Let's start your speech therapy journey!</p>
                        <button class="btn btn-success btn-lg" onclick="startSession()" style="border-radius: 14px; padding: 14px 30px;">
                            <i class="fas fa-rocket me-2"></i>Start Your First Session
                        </button>
                    </div>
                `;
            }
            
            // Update Today's Goals for new user
            const goalsDiv = document.getElementById('todaysGoals');
            if (goalsDiv) {
                goalsDiv.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="goal1">
                        <label class="form-check-label" for="goal1">
                            <strong>🎯 Complete your first therapy session</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="goal2">
                        <label class="form-check-label" for="goal2">
                            Get familiar with the exercises
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="goal3">
                        <label class="form-check-label" for="goal3">
                            Set up your camera and microphone
                        </label>
                    </div>
                `;
            }
            
            // Hide View All button for new users
            const viewAllBtn = document.getElementById('viewAllExercisesBtn');
            if (viewAllBtn) viewAllBtn.style.display = 'none';
            
            // Update milestones for new user
            const milestonesDiv = document.getElementById('milestonesList');
            if (milestonesDiv) {
                milestonesDiv.innerHTML = `
                    <div class="feedback-bubble">
                        <i class="fas fa-flag-checkered me-2" style="color: var(--primary-color);"></i>
                        <strong>First Session</strong> - Complete your first session to unlock!
                    </div>
                    <div class="feedback-bubble">
                        <i class="fas fa-clock me-2" style="color: #9ca3af;"></i>
                        <strong>5 Sessions</strong> - 0/5
                    </div>
                    <div class="feedback-bubble">
                        <i class="fas fa-star me-2" style="color: #9ca3af;"></i>
                        <strong>70+ Score</strong> - Complete sessions to achieve
                    </div>
                `;
            }
            
            // Initialize charts with empty state for new users
            initializeEmptyCharts();
        }
        
        // Hide new user welcome (for returning users)
        function hideNewUserWelcome() {
            // This function ensures the dashboard shows real data
            const noActivityMsg = document.getElementById('noActivityMessage');
            if (noActivityMsg) noActivityMsg.style.display = 'none';
        }
        
        // Initialize empty charts for new users
        function initializeEmptyCharts() {
            if (progressChart) {
                progressChart.data.datasets[0].data = [0];
                progressChart.data.labels = ['Start'];
                progressChart.update();
            }
            if (monthlyChart) {
                monthlyChart.data.datasets[0].data = [0];
                monthlyChart.update();
            }
        }
        
        // Update Progress Page Statistics
        function updateProgressPageStats(data) {
            const totalSessions = data.total_sessions || 0;
            const avgScore = Math.round(data.avg_score || data.average_clarity || 0);
            const bestScore = data.best_score || 0;
            const dayStreak = data.day_streak || 0;
            
            // Calculate stats based on user data
            const overallImprovement = totalSessions > 0 ? Math.min(100, Math.round((avgScore / 100) * 100)) : 0;
            const consistencyScore = totalSessions > 0 ? Math.min(100, Math.round((dayStreak / 7) * 100)) : 0;
            const articulation = avgScore;
            
            // Update progress page elements
            const improvementPercent = document.getElementById('overallImprovementPercent');
            const improvementBar = document.getElementById('overallImprovementBar');
            const consistencyPercent = document.getElementById('consistencyScorePercent');
            const consistencyBar = document.getElementById('consistencyScoreBar');
            const articulationPercent = document.getElementById('articulationPercent');
            const articulationBar = document.getElementById('articulationBar');
            
            if (improvementPercent) improvementPercent.textContent = overallImprovement + '%';
            if (improvementBar) improvementBar.style.width = overallImprovement + '%';
            if (consistencyPercent) consistencyPercent.textContent = consistencyScore + '%';
            if (consistencyBar) consistencyBar.style.width = consistencyScore + '%';
            if (articulationPercent) articulationPercent.textContent = articulation + '%';
            if (articulationBar) articulationBar.style.width = articulation + '%';
        }
        
        // Update Feedback Page Statistics
        function updateFeedbackPageStats(data) {
            const avgScore = Math.round(data.avg_score || data.average_clarity || 0);
            
            const clarityScore = document.getElementById('feedbackClarityScore');
            const clarityBar = document.getElementById('feedbackClarityBar');
            
            if (clarityScore) clarityScore.textContent = avgScore;
            if (clarityBar) clarityBar.style.width = avgScore + '%';
        }
        
        // Update Milestones based on user data
        function updateMilestones(data) {
            const milestonesDiv = document.getElementById('milestonesList');
            if (!milestonesDiv) return;
            
            const totalSessions = data.total_sessions || 0;
            const bestScore = data.best_score || 0;
            const dayStreak = data.day_streak || 0;
            
            let milestonesHtml = '';
            
            // First Session milestone
            if (totalSessions >= 1) {
                milestonesHtml += `
                    <div class="feedback-bubble" style="border-left-color: var(--success-color);">
                        <i class="fas fa-check-circle me-2" style="color: var(--success-color);"></i>
                        <strong>First Session</strong> - Completed ✓
                    </div>`;
            } else {
                milestonesHtml += `
                    <div class="feedback-bubble">
                        <i class="fas fa-clock me-2" style="color: #9ca3af;"></i>
                        <strong>First Session</strong> - Not started
                    </div>`;
            }
            
            // 5 Sessions milestone
            if (totalSessions >= 5) {
                milestonesHtml += `
                    <div class="feedback-bubble" style="border-left-color: var(--success-color);">
                        <i class="fas fa-check-circle me-2" style="color: var(--success-color);"></i>
                        <strong>5 Sessions</strong> - Completed ✓
                    </div>`;
            } else {
                milestonesHtml += `
                    <div class="feedback-bubble">
                        <i class="fas fa-clock me-2" style="color: #9ca3af;"></i>
                        <strong>5 Sessions</strong> - ${totalSessions}/5
                        <div class="progress mt-2">
                            <div class="progress-bar" style="width: ${(totalSessions / 5) * 100}%"></div>
                        </div>
                    </div>`;
            }
            
            // 70+ Score milestone
            if (bestScore >= 70) {
                milestonesHtml += `
                    <div class="feedback-bubble" style="border-left-color: var(--warning-color);">
                        <i class="fas fa-star me-2" style="color: var(--warning-color);"></i>
                        <strong>70+ Score</strong> - Achieved ✓
                    </div>`;
            } else {
                milestonesHtml += `
                    <div class="feedback-bubble">
                        <i class="fas fa-star me-2" style="color: #9ca3af;"></i>
                        <strong>70+ Score</strong> - Best: ${bestScore}/70
                        <div class="progress mt-2">
                            <div class="progress-bar" style="width: ${Math.min(100, (bestScore / 70) * 100)}%"></div>
                        </div>
                    </div>`;
            }
            
            // 10 Sessions milestone
            if (totalSessions >= 10) {
                milestonesHtml += `
                    <div class="feedback-bubble" style="border-left-color: var(--success-color);">
                        <i class="fas fa-trophy me-2" style="color: var(--success-color);"></i>
                        <strong>10 Sessions</strong> - Completed ✓
                    </div>`;
            } else {
                milestonesHtml += `
                    <div class="feedback-bubble">
                        <i class="fas fa-clock me-2" style="color: #9ca3af;"></i>
                        <strong>10 Sessions</strong> - ${totalSessions}/10
                        <div class="progress mt-2">
                            <div class="progress-bar" style="width: ${(totalSessions / 10) * 100}%"></div>
                        </div>
                    </div>`;
            }
            
            milestonesDiv.innerHTML = milestonesHtml;
        }
        
        // Update Charts with real user data (called from loadUserProfile)
        function updateChartsWithData(data) {
            const weeklyProgress = data.weekly_progress || [];
            const totalSessions = data.total_sessions || 0;
            
            console.log('updateChartsWithData called with:', data);
            
            // Update progress chart if it exists and has data
            if (progressChart && weeklyProgress.length > 0 && weeklyProgress.some(s => s > 0)) {
                progressChart.data.datasets[0].data = weeklyProgress;
                progressChart.data.labels = weeklyProgress.map((_, i) => `Session ${i + 1}`);
                progressChart.update();
                console.log('Progress chart updated with:', weeklyProgress);
            }
            
            // Update monthly chart if it exists
            if (monthlyChart && totalSessions > 0) {
                // For simplicity, put all sessions in current week if no historical data
                monthlyChart.data.datasets[0].data = [0, 0, 0, totalSessions];
                monthlyChart.update();
                console.log('Monthly chart updated with total sessions:', totalSessions);
            }
            
            // Also call the full chart data loader for more accurate weekly breakdown
            loadUserChartData();
        }
        
        // Update Progress Timelines in Feedback and Help pages
        async function updateProgressTimelines() {
            const username = localStorage.getItem('amacUsername') || sessionStorage.getItem('amacUsername') || 'default';
            
            try {
                const response = await fetch(`/api/therapy/sessions?user_id=${encodeURIComponent(username)}`);
                if (response.ok) {
                    const data = await response.json();
                    const sessions = data.sessions || [];
                    
                    // Update feedback page timeline
                    const feedbackTimeline = document.getElementById('feedbackProgressTimeline');
                    // Update help page timeline
                    const helpTimeline = document.getElementById('helpProgressTimeline');
                    
                    if (sessions.length === 0) {
                        // Keep default "no sessions" message
                        return;
                    }
                    
                    // Build timeline HTML
                    const today = new Date();
                    let html = '';
                    
                    sessions.slice(0, 4).forEach((session, index) => {
                        const sessionDate = new Date(session.date);
                        const diffDays = Math.floor((today - sessionDate) / (1000 * 60 * 60 * 24));
                        
                        let dateLabel = '';
                        if (diffDays === 0) dateLabel = 'Today';
                        else if (diffDays === 1) dateLabel = 'Yesterday';
                        else dateLabel = diffDays + ' days ago';
                        
                        const score = session.avg_score || 0;
                        const isGood = score >= 70;
                        const color = isGood ? '#22c55e' : '#f59e0b';
                        const isLast = index === sessions.length - 1 || index === 3;
                        
                        html += `
                            <div style="position: relative; margin-bottom: ${isLast ? '0' : '20px'}; padding-bottom: ${isLast ? '0' : '15px'}; border-bottom: ${isLast ? 'none' : '1px solid #f3f4f6'};">
                                <div style="position: absolute; left: -30px; top: 5px; width: 15px; height: 15px; border-radius: 50%; background: ${color}; box-shadow: 0 0 0 4px ${isGood ? 'rgba(34, 197, 94, 0.2)' : 'rgba(245, 158, 11, 0.2)'};"></div>
                                <small style="color: #888;">${dateLabel}</small>
                                <p style="margin: 0; font-weight: 600; color: #333;">Score: ${score}/100</p>
                            </div>
                        `;
                    });
                    
                    if (feedbackTimeline) feedbackTimeline.innerHTML = html;
                    if (helpTimeline) helpTimeline.innerHTML = html;
                }
            } catch (error) {
                console.error('Error updating progress timelines:', error);
            }
        }
        
        // Update recent activity with saved exercises
        function updateRecentActivityFromSavedExercises() {
            if (completedExercises.length === 0) return;
            
            // Group exercises by date
            const exercisesByDate = {};
            completedExercises.forEach(ex => {
                const date = new Date(ex.date || ex.timestamp);
                const dateKey = date.toDateString();
                if (!exercisesByDate[dateKey]) {
                    exercisesByDate[dateKey] = {
                        date: date,
                        exercises: [],
                        totalScore: 0
                    };
                }
                exercisesByDate[dateKey].exercises.push(ex);
                exercisesByDate[dateKey].totalScore += ex.score;
            });
            
            // Convert to array and sort by date
            const sessions = Object.values(exercisesByDate).map(group => ({
                date: group.date,
                exercises_completed: group.exercises.length,
                average_score: group.totalScore / group.exercises.length
            })).sort((a, b) => b.date - a.date).slice(0, 5);
            
            if (sessions.length > 0) {
                updateRecentActivityDisplay(sessions);
            }
        }
        
        // Update recent activity display
        function updateRecentActivityDisplay(sessions) {
            const recentActivityDiv = document.getElementById('recentActivity');
            const noActivityMsg = document.getElementById('noActivityMessage');
            const viewAllBtn = document.getElementById('viewAllExercisesBtn');
            
            if (!recentActivityDiv) return;
            
            if (sessions.length === 0) {
                if (noActivityMsg) noActivityMsg.style.display = 'block';
                if (viewAllBtn) viewAllBtn.style.display = 'none';
                return;
            }
            
            if (noActivityMsg) noActivityMsg.style.display = 'none';
            if (viewAllBtn) viewAllBtn.style.display = 'block';
            
            let html = '';
            sessions.forEach(session => {
                const sessionDate = session.date;
                const dateStr = sessionDate.toLocaleDateString();
                const isToday = sessionDate.toDateString() === new Date().toDateString();
                const isYesterday = sessionDate.toDateString() === new Date(Date.now() - 86400000).toDateString();
                const dateLabel = isToday ? 'Today' : isYesterday ? 'Yesterday' : dateStr;
                
                html += `
                    <div class="exercise-card">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>Session: ${dateLabel}</strong>
                                <p class="mb-1">Completed ${session.exercises_completed} exercises</p>
                                <small class="text-muted">Avg Score: ${session.average_score.toFixed(1)}/100</small>
                            </div>
                            <span class="badge bg-success">Completed</span>
                        </div>
                    </div>
                `;
            });
            
            recentActivityDiv.innerHTML = html;
        }
        
        // Show exercise history modal/page
        function showExerciseHistory() {
            // Create or show exercise history
            const historyHtml = `
                <div class="dashboard-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-list me-2"></i>Exercise History</h4>
                        <button class="btn btn-sm btn-outline-secondary" onclick="closeExerciseHistory()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="exerciseHistoryList" class="mt-3">
                        ${renderExerciseHistory()}
                    </div>
                </div>
            `;
            
            // If on therapy page, switch to dashboard to show history
            const dashboardPage = document.getElementById('dashboard');
            if (dashboardPage && !dashboardPage.classList.contains('active')) {
                showPage('dashboard');
            }
            
            // Insert history into a new section or modal
            let historySection = document.getElementById('exerciseHistorySection');
            if (!historySection) {
                historySection = document.createElement('div');
                historySection.id = 'exerciseHistorySection';
                historySection.innerHTML = historyHtml;
                const dashboardContent = document.getElementById('dashboard');
                if (dashboardContent) {
                    dashboardContent.appendChild(historySection);
                }
            } else {
                historySection.innerHTML = historyHtml;
                historySection.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // Render exercise history
        function renderExerciseHistory() {
            if (completedExercises.length === 0) {
                return '<div class="text-center p-4 text-muted"><p>No exercises completed yet.</p></div>';
            }
            
            // Group by date
            const exercisesByDate = {};
            completedExercises.forEach(ex => {
                const date = new Date(ex.date || ex.timestamp);
                const dateKey = date.toDateString();
                if (!exercisesByDate[dateKey]) {
                    exercisesByDate[dateKey] = [];
                }
                exercisesByDate[dateKey].push(ex);
            });
            
            let html = '';
            const sortedDates = Object.keys(exercisesByDate).sort((a, b) => 
                new Date(b) - new Date(a)
            );
            
            sortedDates.forEach(dateKey => {
                const date = new Date(dateKey);
                const exercises = exercisesByDate[dateKey];
                const avgScore = exercises.reduce((sum, ex) => sum + ex.score, 0) / exercises.length;
                
                html += `
                    <div class="exercise-card mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5><i class="fas fa-calendar me-2"></i>${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h5>
                            <span class="badge bg-primary">${exercises.length} exercises • Avg: ${avgScore.toFixed(1)}</span>
                        </div>
                        <div class="list-group">
                `;
                
                exercises.forEach((ex, idx) => {
                    const scoreColor = ex.score >= 80 ? 'success' : ex.score >= 60 ? 'warning' : 'danger';
                    const time = new Date(ex.date || ex.timestamp).toLocaleTimeString();
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${ex.exercise.target}</strong>
                                    <br>
                                    <small class="text-muted">
                                        ${ex.exercise.type} • ${ex.exercise.instructions}
                                    </small>
                                    <br>
                                    <small class="text-muted">${time}</small>
                                </div>
                                <span class="badge bg-${scoreColor} fs-6">${ex.score}/100</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        // Close exercise history
        function closeExerciseHistory() {
            const historySection = document.getElementById('exerciseHistorySection');
            if (historySection) {
                historySection.remove();
            }
        }
        
        // Start therapy session (from dashboard)
        function startSession() {
            showPage('therapy');
            startTherapySession();
        }
        
        // Start therapy session (from therapy page)
        async function startTherapySession() {
            try {
                // Get current username from storage
                const username = localStorage.getItem('amacUsername') || sessionStorage.getItem('amacUsername') || 'test_user';
                
                // Record session start time
                sessionStartTime = Date.now();
                
                const response = await fetch('/api/therapy/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: username })
                });
                
                const data = await response.json();
                currentSession = data.session_id;
                sessionExercises = data.total_exercises || 4;
                
                // Update UI
                document.getElementById('sessionStatus').textContent = 'Session Active';
                document.getElementById('sessionStatus').className = 'badge bg-success fs-6';
                
                document.getElementById('currentExercise').innerHTML = `
                    <h3>Session Started!</h3>
                    <p>Loading first exercise...</p>
                `;
                
                document.getElementById('progressIndicator').style.display = 'block';
                document.getElementById('sessionControls').style.display = 'block';
                
                // Reset exercise counters
                completedExercises = [];
                
                // Load first exercise from API
                if (data.first_exercise) {
                    currentExercise = {
                        exercise_number: 1,
                        total_exercises: data.total_exercises,
                        ...data.first_exercise
                    };
                    setTimeout(() => {
                        displayCurrentExercise();
                        updateProgressIndicator();
                    }, 1000);
                } else {
                    // Fallback to sample exercise
                    setTimeout(() => {
                        loadSampleExercise();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Session error:', error);
                alert('Failed to start session. Please try again.');
            }
        }
        
        // Load sample exercise (for demo)
        function loadSampleExercise() {
            const exercises = [
                // === PHONEME EXERCISES (Easy - Difficulty 1) ===
                {
                    target: "AH",
                    instructions: "Say 'AH' with open mouth, hold for 3 seconds",
                    type: "phoneme",
                    difficulty: 1
                },
                {
                    target: "EE",
                    instructions: "Smile wide, say 'EE' clearly",
                    type: "phoneme",
                    difficulty: 1
                },
                {
                    target: "OO",
                    instructions: "Round your lips, say 'OO' like in 'moon'",
                    type: "phoneme",
                    difficulty: 1
                },
                {
                    target: "OH",
                    instructions: "Open mouth in O shape, say 'OH' smoothly",
                    type: "phoneme",
                    difficulty: 1
                },
                {
                    target: "MM",
                    instructions: "Close lips gently, hum 'MM' for 3 seconds",
                    type: "phoneme",
                    difficulty: 1
                },
                {
                    target: "SS",
                    instructions: "Keep teeth together, make a snake 'SS' sound",
                    type: "phoneme",
                    difficulty: 1
                },
                {
                    target: "SH",
                    instructions: "Pucker lips slightly, say 'SH' like 'shush'",
                    type: "phoneme",
                    difficulty: 1
                },
                {
                    target: "TH",
                    instructions: "Place tongue between teeth, say 'TH' gently",
                    type: "phoneme",
                    difficulty: 1
                },
                
                // === WORD EXERCISES (Medium - Difficulty 2) ===
                {
                    target: "Hello",
                    instructions: "Say 'Hello' clearly with good breath support",
                    type: "word", 
                    difficulty: 2
                },
                {
                    target: "Thank you",
                    instructions: "Pronounce clearly with emphasis on 'TH' sound",
                    type: "word",
                    difficulty: 2
                },
                {
                    target: "Please",
                    instructions: "Say smoothly, focus on the 'PL' blend",
                    type: "word",
                    difficulty: 2
                },
                {
                    target: "Welcome",
                    instructions: "Emphasize both syllables: WEL-come",
                    type: "word",
                    difficulty: 2
                },
                {
                    target: "Water",
                    instructions: "Focus on clear 'W' and 'T' sounds",
                    type: "word",
                    difficulty: 2
                },
                {
                    target: "Beautiful",
                    instructions: "Break into syllables: Beau-ti-ful",
                    type: "word",
                    difficulty: 2
                },
                {
                    target: "Yesterday",
                    instructions: "Emphasize each syllable: Yes-ter-day",
                    type: "word",
                    difficulty: 2
                },
                {
                    target: "Computer",
                    instructions: "Clear pronunciation: Com-pu-ter",
                    type: "word",
                    difficulty: 2
                },
                {
                    target: "Elephant",
                    instructions: "Focus on the 'PH' sound: El-e-phant",
                    type: "word",
                    difficulty: 2
                },
                {
                    target: "Chocolate",
                    instructions: "Say clearly: Choc-o-late",
                    type: "word",
                    difficulty: 2
                },
                
                // === SENTENCE EXERCISES (Hard - Difficulty 3) ===
                {
                    target: "Good morning",
                    instructions: "Greet naturally with clear pronunciation",
                    type: "sentence",
                    difficulty: 3
                },
                {
                    target: "The sun is bright",
                    instructions: "Read this sentence with clear 'S' and 'T' sounds",
                    type: "sentence",
                    difficulty: 3
                },
                {
                    target: "How are you today?",
                    instructions: "Ask with natural intonation, raise pitch at end",
                    type: "sentence",
                    difficulty: 3
                },
                {
                    target: "Nice to meet you",
                    instructions: "Speak warmly with clear 'N' and 'M' sounds",
                    type: "sentence",
                    difficulty: 3
                },
                {
                    target: "I would like some water",
                    instructions: "Speak clearly with proper pauses between words",
                    type: "sentence",
                    difficulty: 3
                },
                {
                    target: "The quick brown fox",
                    instructions: "Articulate each word distinctly",
                    type: "sentence",
                    difficulty: 3
                },
                {
                    target: "She sells sea shells",
                    instructions: "Focus on the 'S' and 'SH' sounds - take it slow",
                    type: "sentence",
                    difficulty: 3
                },
                {
                    target: "Peter Piper picked peppers",
                    instructions: "Practice the 'P' sound carefully, don't rush",
                    type: "sentence",
                    difficulty: 3
                },
                {
                    target: "Red lorry, yellow lorry",
                    instructions: "Focus on 'R', 'L', and 'Y' sounds",
                    type: "sentence",
                    difficulty: 3
                },
                {
                    target: "I am feeling great today",
                    instructions: "Express positively with natural rhythm",
                    type: "sentence",
                    difficulty: 3
                },
                {
                    target: "Can you help me please?",
                    instructions: "Ask politely with rising intonation",
                    type: "sentence",
                    difficulty: 3
                },
                {
                    target: "The weather is wonderful",
                    instructions: "Focus on 'W' and 'TH' sounds",
                    type: "sentence",
                    difficulty: 3
                },
                {
                    target: "My name is...",
                    instructions: "Complete with your name, speak confidently",
                    type: "sentence",
                    difficulty: 3
                },
                {
                    target: "Let's practice together",
                    instructions: "Emphasize the 'PR' blend in practice",
                    type: "sentence",
                    difficulty: 3
                },
                {
                    target: "I can speak clearly",
                    instructions: "Say with confidence and clear articulation",
                    type: "sentence",
                    difficulty: 3
                }
            ];
            
            const randomExercise = exercises[Math.floor(Math.random() * exercises.length)];
            
            currentExercise = {
                exercise_number: completedExercises.length + 1,
                total_exercises: sessionExercises || 4,
                ...randomExercise
            };
            
            displayCurrentExercise();
            updateProgressIndicator();
        }
        
        // Display current exercise
        function displayCurrentExercise() {
            if (!currentExercise) return;
            
            const difficultyColors = {
                1: { bg: 'rgba(16, 185, 129, 0.1)', color: '#10b981', label: 'Easy' },
                2: { bg: 'rgba(245, 158, 11, 0.1)', color: '#f59e0b', label: 'Medium' },
                3: { bg: 'rgba(239, 68, 68, 0.1)', color: '#ef4444', label: 'Hard' }
            };
            const difficulty = difficultyColors[currentExercise.difficulty] || difficultyColors[1];
            
            document.getElementById('currentExercise').innerHTML = `
                <div class="text-center">
                    <div class="d-flex justify-content-center gap-2 mb-3">
                        <span class="badge" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));">
                            Exercise ${currentExercise.exercise_number}/${currentExercise.total_exercises}
                        </span>
                        <span class="badge" style="background: ${difficulty.bg}; color: ${difficulty.color};">
                            ${difficulty.label}
                        </span>
                    </div>
                    
                    <div class="score-display my-4" style="font-size: 4rem; line-height: 1;">${currentExercise.target}</div>
                    
                    <p class="lead text-muted mb-4">${currentExercise.instructions}</p>
                    
                    <div class="p-3 mx-auto" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05)); border-radius: 12px; max-width: 400px;">
                        <i class="fas fa-lightbulb me-2" style="color: var(--warning-color);"></i>
                        <strong>Tip:</strong> 
                        ${currentExercise.type === 'phoneme' ? 'Hold the sound steady for 3 seconds' : 
                          currentExercise.type === 'word' ? 'Break into syllables if needed' : 
                          'Pause briefly between words'}
                    </div>
                </div>
            `;
        }
        
        // Update progress indicator
        function updateProgressIndicator() {
            if (!currentExercise) return;
            
            const progress = ((currentExercise.exercise_number - 1) / currentExercise.total_exercises) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = 
                `${currentExercise.exercise_number - 1}/${currentExercise.total_exercises} exercises`;
        }
        
        // Record attempt
        async function recordAttempt() {
            // Show recording
            const recordBtn = document.getElementById('recordBtn');
            recordBtn.innerHTML = '<i class="fas fa-circle"></i> Recording...';
            recordBtn.disabled = true;
            
            let score = 0;
            
            // Try to use API if session exists
            if (currentSession && currentExercise) {
                try {
                    const response = await fetch('/api/therapy/process-attempt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: currentSession,
                            exercise_id: currentExercise.id || currentExercise.exercise_number,
                            audio_data: 'demo_audio_data' // In real implementation, send actual audio
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.result) {
                        score = data.result.score || (60 + Math.floor(Math.random() * 35));
                        
                        // Update current session if API returns next exercise
                        if (data.next_exercise) {
                            // There's a next exercise available
                        } else if (data.session_summary) {
                            // Session is complete
                        }
                    } else {
                        // Fallback to random score
                        score = 60 + Math.floor(Math.random() * 35);
                    }
                } catch (error) {
                    console.error('Error processing attempt:', error);
                    // Fallback to random score
                    score = 60 + Math.floor(Math.random() * 35);
                }
            } else {
                // Simulate processing for demo
                score = 60 + Math.floor(Math.random() * 35);
            }
            
            // Simulate processing delay
            setTimeout(() => {
                // Store completed exercise
                const completedExercise = {
                    exercise: currentExercise,
                    score: score,
                    timestamp: new Date().toLocaleTimeString(),
                    date: new Date().toISOString(),
                    session_id: currentSession || 'local_session'
                };
                
                completedExercises.push(completedExercise);
                
                // Save to localStorage for persistence
                saveCompletedExercises();
                
                // Update stats
                updateSessionStats(score);
                
                // Show feedback
                showExerciseFeedback(score);
                
                // Update recent exercises
                updateRecentExercises();
                
                // Reset button
                recordBtn.innerHTML = '<i class="fas fa-microphone me-2"></i>Record Attempt';
                recordBtn.disabled = false;
                
                // Hide record and skip buttons, show Next Exercise button
                recordBtn.style.display = 'none';
                document.getElementById('skipBtn').style.display = 'none';
                
                // Show Next Exercise button or complete session
                if (completedExercises.length >= currentExercise.total_exercises) {
                    // All exercises done, show completion after a delay
                    setTimeout(() => {
                        completeSession();
                    }, 3000);
                } else {
                    // Show Next Exercise button
                    document.getElementById('nextExerciseBtn').style.display = 'inline-block';
                }
                
            }, 2000);
        }
        
        // Skip exercise
        function skipExercise() {
            if (completedExercises.length >= currentExercise.total_exercises - 1) {
                completeSession();
            } else {
                loadNextExercise();
            }
        }
        
        // Load next exercise (called from Next Exercise button)
        async function loadNextExercise() {
            // Hide Next Exercise button
            document.getElementById('nextExerciseBtn').style.display = 'none';
            
            // Show Record and Skip buttons again
            document.getElementById('recordBtn').style.display = 'inline-block';
            document.getElementById('skipBtn').style.display = 'inline-block';
            
            // Check if we should use API or sample exercises
            if (currentSession) {
                // Use API to get next exercise
                try {
                    const response = await fetch(`/api/therapy/current-exercise/${currentSession}`);
                    const data = await response.json();
                    
                    if (data.completed) {
                        // Session complete
                        completeSession();
                        return;
                    }
                    
                    if (data.exercise) {
                        currentExercise = data.exercise;
                        displayCurrentExercise();
                        updateProgressIndicator();
                        return;
                    }
                } catch (error) {
                    console.error('Error fetching next exercise:', error);
                    // Fall back to sample exercise
                }
            }
            
            // Fall back to sample exercise if API fails or no session
            loadSampleExercise();
        }
        
        // Update session stats
        function updateSessionStats(score) {
            // Update session score
            const currentScore = parseInt(document.getElementById('sessionScore').textContent);
            const newScore = Math.max(currentScore, score);
            document.getElementById('sessionScore').textContent = newScore;
            
            // Update exercises done
            document.getElementById('exercisesDone').textContent = completedExercises.length;
            
            // Update dashboard stats
            document.getElementById('bestScore').textContent = 
                Math.max(parseInt(document.getElementById('bestScore').textContent), score);
        }
        
        // Show exercise feedback
        function showExerciseFeedback(score) {
            let feedback = '';
            let color = '#10b981';
            let bgColor = 'rgba(16, 185, 129, 0.1)';
            let icon = 'check-circle';
            
            if (score >= 85) {
                feedback = 'Excellent! Perfect clarity.';
                color = '#10b981';
                bgColor = 'rgba(16, 185, 129, 0.1)';
                icon = 'star';
            } else if (score >= 70) {
                feedback = 'Good job! Clear speech.';
                color = '#667eea';
                bgColor = 'rgba(102, 126, 234, 0.1)';
                icon = 'thumbs-up';
            } else if (score >= 60) {
                feedback = 'Fair. Try speaking slower.';
                color = '#f59e0b';
                bgColor = 'rgba(245, 158, 11, 0.1)';
                icon = 'info-circle';
            } else {
                feedback = 'Needs practice. Focus on articulation.';
                color = '#ef4444';
                bgColor = 'rgba(239, 68, 68, 0.1)';
                icon = 'exclamation-circle';
            }
            
            // Show toast
            showToast(`Score: ${score}/100 - ${feedback}`, score >= 70 ? 'success' : score >= 60 ? 'warning' : 'error');
            
            document.getElementById('feedbackContainer').innerHTML = `
                <div style="background: ${bgColor}; border-radius: 16px; padding: 25px; border-left: 5px solid ${color};">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-${icon} me-2" style="color: ${color}; font-size: 24px;"></i>
                                <h5 class="mb-0" style="color: #1a1a2e;">Score: ${score}/100</h5>
                            </div>
                            <p class="mb-0 text-muted">${feedback}</p>
                        </div>
                        <div class="text-end">
                            <div class="score-display" style="font-size: 3rem;">${score}</div>
                            <small class="text-muted">Clarity</small>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3" style="background: white; border-radius: 12px;">
                        <h6 class="mb-2"><i class="fas fa-lightbulb me-2" style="color: var(--warning-color);"></i>Suggestion:</h6>
                        <p class="mb-0 text-muted">${getRandomSuggestion()}</p>
                    </div>
                </div>
            `;
        }
        
        // Get random suggestion
        function getRandomSuggestion() {
            const suggestions = [
                "Take a deep breath before speaking",
                "Speak a bit slower for better clarity",
                "Focus on consonant endings",
                "Use more breath support",
                "Practice with shorter phrases first"
            ];
            return suggestions[Math.floor(Math.random() * suggestions.length)];
        }
        
        // Update recent exercises
        function updateRecentExercises() {
            const recentDiv = document.getElementById('recentExercises');
            
            if (completedExercises.length === 0) {
                recentDiv.innerHTML = `
                    <div class="text-center p-3">
                        <i class="fas fa-clock fa-2x mb-3" style="color: #d1d5db;"></i>
                        <p class="text-muted mb-0">No exercises completed yet</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            const recent = completedExercises.slice(-3).reverse();
            
            recent.forEach(item => {
                const scoreColor = item.score >= 80 ? '#10b981' : item.score >= 60 ? '#f59e0b' : '#ef4444';
                
                html += `
                    <div class="exercise-card" style="margin: 10px 0; padding: 12px 15px;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong style="color: #1a1a2e;">${item.exercise.target}</strong>
                                <br>
                                <small class="text-muted">${item.exercise.type} • ${item.timestamp}</small>
                            </div>
                            <span class="badge" style="background: ${scoreColor};">${item.score}</span>
                        </div>
                    </div>
                `;
            });
            
            recentDiv.innerHTML = html;
        }
        
        // Complete session
        async function completeSession() {
            // Save all completed exercises to localStorage and database
            await saveCompletedExercises();
            
            document.getElementById('sessionStatus').textContent = 'Session Complete';
            document.getElementById('sessionStatus').className = 'badge' ;
            document.getElementById('sessionStatus').style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
            
            const avgScore = completedExercises.length > 0 
                ? Math.round(completedExercises.reduce((sum, ex) => sum + ex.score, 0) / completedExercises.length)
                : 0;
            
            // Show toast notification
            showToast('🎉 Session completed successfully!', 'success');
            
            document.getElementById('currentExercise').innerHTML = `
                <div class="text-center p-4">
                    <div style="width: 100px; height: 100px; margin: 0 auto 20px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-trophy fa-3x" style="color: #f59e0b;"></i>
                    </div>
                    <h3 style="color: var(--success-color); font-weight: 700;">Session Complete! 🎉</h3>
                    <p class="text-muted mb-4">Great work! You completed ${completedExercises.length} exercises.</p>
                    
                    <div class="row g-3 mt-4">
                        <div class="col-4">
                            <div class="p-3" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border-radius: 12px;">
                                <div class="h2 fw-bold" style="color: var(--primary-color);">${completedExercises.length}</div>
                                <small class="fw-500">Exercises</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border-radius: 12px;">
                                <div class="h2 fw-bold" style="color: var(--success-color);">${document.getElementById('sessionScore').textContent}</div>
                                <small class="fw-500">Best Score</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1)); border-radius: 12px;">
                                <div class="h2 fw-bold" style="color: var(--warning-color);">${avgScore}</div>
                                <small class="fw-500">Avg Score</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-outline-primary me-2" onclick="showExerciseHistory()">
                            <i class="fas fa-list me-2"></i>Review Exercises
                        </button>
                        <button class="btn btn-success" onclick="startTherapySession()">
                            <i class="fas fa-play me-2"></i>New Session
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('progressIndicator').style.display = 'none';
            document.getElementById('sessionControls').style.display = 'none';
            
            // Update recent activity immediately
            updateRecentActivityFromSavedExercises();
            
            // Reload user profile to get updated stats
            await loadUserProfile();
        }
        
        // Initialize charts
        function initializeCharts() {
            // Progress Chart - Start empty for new users
            const progressCtx = document.getElementById('progressChart').getContext('2d');
            progressChart = new Chart(progressCtx, {
                type: 'line',
                data: {
                    labels: ['Start'],
                    datasets: [{
                        label: 'Clarity Score',
                        data: [0],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                font: { family: 'Inter' }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { family: 'Inter' }
                            }
                        }
                    }
                }
            });
            
            // Monthly Chart - Start empty for new users
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Sessions Completed',
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)', 
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                font: { family: 'Inter' }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { family: 'Inter' }
                            }
                        }
                    }
                }
            });
            
            // Load user's actual progress data
            loadUserChartData();
        }
        
        // Load chart data from user sessions
        async function loadUserChartData() {
            try {
                const username = localStorage.getItem('amacUsername') || sessionStorage.getItem('amacUsername') || 'guest';
                const response = await fetch(`/api/therapy/sessions?username=${encodeURIComponent(username)}`);
                if (response.ok) {
                    const data = await response.json();
                    const sessions = data.sessions || [];
                    
                    console.log('Loading chart data for user:', username, 'Sessions:', sessions.length);
                    
                    if (sessions && sessions.length > 0) {
                        // Update Progress Chart with real session scores
                        const labels = sessions.map((s, i) => `Session ${i + 1}`);
                        const scores = sessions.map(s => s.avg_score || s.score || 0);
                        
                        console.log('Chart labels:', labels, 'Scores:', scores);
                        
                        if (progressChart) {
                            progressChart.data.labels = labels;
                            progressChart.data.datasets[0].data = scores;
                            progressChart.update();
                        }
                        
                        // Update Monthly Chart - group sessions by week
                        const weeklyData = [0, 0, 0, 0];
                        const now = new Date();
                        sessions.forEach(session => {
                            const sessionDate = new Date(session.date);
                            const daysDiff = Math.floor((now - sessionDate) / (1000 * 60 * 60 * 24));
                            if (daysDiff < 7) weeklyData[3]++;
                            else if (daysDiff < 14) weeklyData[2]++;
                            else if (daysDiff < 21) weeklyData[1]++;
                            else if (daysDiff < 28) weeklyData[0]++;
                        });
                        
                        // If all sessions are today, show them in the current week
                        if (weeklyData.every(w => w === 0) && sessions.length > 0) {
                            weeklyData[3] = sessions.length;
                        }
                        
                        if (monthlyChart) {
                            monthlyChart.data.datasets[0].data = weeklyData;
                            monthlyChart.update();
                        }
                    } else {
                        // New user - show empty charts
                        console.log('No sessions found for user, showing empty charts');
                        if (progressChart) {
                            progressChart.data.labels = ['Start'];
                            progressChart.data.datasets[0].data = [0];
                            progressChart.update();
                        }
                        if (monthlyChart) {
                            monthlyChart.data.datasets[0].data = [0, 0, 0, 0];
                            monthlyChart.update();
                        }
                    }
                }
            } catch (error) {
                console.error('Could not load chart data:', error);
            }
        }
        
        // Update progress charts
        function updateProgressCharts() {
            // Update progress chart with new data
            if (progressChart && completedExercises.length > 0) {
                const latestScore = completedExercises[completedExercises.length - 1].score;
                progressChart.data.datasets[0].data.push(latestScore);
                progressChart.data.labels.push('Now');
                progressChart.update();
            }
        }
        
        // ============ PDF REPORT DOWNLOAD ============
        async function downloadPDFReport() {
            const username = localStorage.getItem('amacUsername') || sessionStorage.getItem('amacUsername') || 'User';
            
            // Fetch actual user session data
            let exercisesToShow = [];
            let totalExercises = 0;
            let avgScore = 0;
            let bestScore = 0;
            
            try {
                const response = await fetch(`/api/therapy/sessions?username=${username}`);
                if (response.ok) {
                    const sessions = await response.json();
                    if (sessions && sessions.length > 0) {
                        exercisesToShow = sessions.map(s => ({
                            target: s.target || s.exercise_type || 'Exercise',
                            type: s.type || s.category || 'practice',
                            score: s.score || 0,
                            timestamp: new Date(s.date).getTime()
                        }));
                        totalExercises = sessions.length;
                        const scores = sessions.map(s => s.score || 0);
                        avgScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
                        bestScore = Math.max(...scores);
                    }
                }
            } catch (error) {
                console.log('Could not fetch session data:', error);
            }
            
            // Get chart as image
            let chartImage = '';
            let monthlyImage = '';
            
            try {
                const chartCanvas = document.getElementById('progressChart');
                if (chartCanvas) chartImage = chartCanvas.toDataURL('image/png');
                
                const monthlyCanvas = document.getElementById('monthlyChart');
                if (monthlyCanvas) monthlyImage = monthlyCanvas.toDataURL('image/png');
            } catch (e) {
                console.log('Could not capture chart images:', e);
            }
            
            // Build exercises table rows
            let exerciseRows = '';
            if (exercisesToShow.length === 0) {
                exerciseRows = '<tr><td colspan="5" style="text-align: center; color: #888; padding: 30px;">No exercises completed yet. Start your first therapy session!</td></tr>';
            } else {
                exercisesToShow.forEach(function(ex, i) {
                    const date = new Date(ex.timestamp || Date.now());
                    const dateStr = date.toLocaleDateString();
                    const timeStr = date.toLocaleTimeString();
                    exerciseRows += '<tr><td>' + (i + 1) + '</td><td>' + (ex.target || 'N/A') + '</td><td>' + (ex.type || 'N/A') + '</td><td>' + (ex.score || 0) + '%</td><td>' + dateStr + ' ' + timeStr + '</td></tr>';
                });
            }
            
            // Create PDF content
            const pdfContent = '<!DOCTYPE html><html><head><title>AMAC Therapy Progress Report</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;padding:40px;color:#333}.header{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid #667eea}.header h1{color:#667eea;font-size:28px;margin-bottom:5px}.section{margin-bottom:30px}.section h3{color:#667eea;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #eee}.stats-box{display:flex;justify-content:space-around;margin-bottom:20px}.stat-item{text-align:center;padding:20px;background:#f8f9fa;border-radius:10px}.stat-item .value{font-size:32px;font-weight:bold;color:#667eea}.stat-item .label{font-size:12px;color:#666;margin-top:5px}table{width:100%;border-collapse:collapse;margin-top:15px}th,td{padding:12px;text-align:left;border-bottom:1px solid #eee}th{background:#667eea;color:white}.footer{text-align:center;margin-top:40px;padding-top:20px;border-top:2px solid #eee;color:#888;font-size:12px}</style></head><body><div class="header"><h1>🎯 AMAC Speech Therapy</h1><p>Progress Report - ' + username + '</p></div><div class="section"><h3>📊 Performance Summary</h3><div class="stats-box"><div class="stat-item"><div class="value">' + totalExercises + '</div><div class="label">Exercises Done</div></div><div class="stat-item"><div class="value">' + avgScore + '%</div><div class="label">Average Score</div></div><div class="stat-item"><div class="value">' + bestScore + '%</div><div class="label">Best Score</div></div></div></div><div class="section"><h3>📝 Recent Exercises</h3><table><thead><tr><th>#</th><th>Target</th><th>Type</th><th>Score</th><th>Date & Time</th></tr></thead><tbody>' + exerciseRows + '</tbody></table></div><div class="footer"><p>Generated by AMAC Speech Therapy System</p><p>Report Date: ' + new Date().toLocaleString() + '</p></div></body></html>';
            
            // Open in new window for printing
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            if (!printWindow) {
                alert('Please allow popups to download the PDF report');
                return;
            }
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(function() {
                printWindow.print();
            }, 500);
        }
        
        // ============ CSV EXPORT ============
        async function exportCSVData() {
            const username = localStorage.getItem('amacUsername') || sessionStorage.getItem('amacUsername') || 'User';
            
            // Fetch actual user session data
            let dataToExport = [];
            
            try {
                const response = await fetch(`/api/therapy/sessions?username=${username}`);
                if (response.ok) {
                    const sessions = await response.json();
                    if (sessions && sessions.length > 0) {
                        dataToExport = sessions.map(s => ({
                            target: s.target || s.exercise_type || 'Exercise',
                            type: s.type || s.category || 'practice',
                            difficulty: s.difficulty || 1,
                            score: s.score || 0,
                            feedback: s.feedback || 'Good effort',
                            timestamp: new Date(s.date).getTime()
                        }));
                    }
                }
            } catch (error) {
                console.log('Could not fetch session data:', error);
            }
            
            // CSV headers
            let csvContent = 'Exercise Number,Target,Type,Difficulty,Score,Feedback,Date,Time\n';
            
            if (dataToExport.length === 0) {
                // Empty state for new users
                csvContent += '"No exercises completed yet","","","","","","",""\n';
                alert('No exercises to export yet. Complete some therapy sessions first!');
            } else {
                // Add data rows with date and time
                dataToExport.forEach(function(ex, index) {
                    const date = new Date(ex.timestamp || Date.now());
                    const dateStr = date.toLocaleDateString();
                    const timeStr = date.toLocaleTimeString();
                    csvContent += (index + 1) + ',"' + ex.target + '","' + ex.type + '",' + ex.difficulty + ',' + ex.score + '%,"' + ex.feedback + '","' + dateStr + '","' + timeStr + '"\n';
                });
            }
            
            // Create download with date and time in filename
            const now = new Date();
            const dateTimeStr = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'AMAC_Progress_' + username + '_' + dateTimeStr + '.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            if (dataToExport.length > 0) {
                alert('CSV file downloaded with ' + dataToExport.length + ' exercises!');
            }
        }
        
        // ============ CHATBOT FUNCTIONS ============
        let chatbotOpen = false;
        
        function toggleChatbot() {
            try {
                const chatModal = document.getElementById('chatbotModal');
                if (!chatModal) {
                    console.error('Chatbot modal not found');
                    showToast('Chatbot is loading...', 'info');
                    return;
                }
                chatbotOpen = !chatbotOpen;
                chatModal.style.display = chatbotOpen ? 'block' : 'none';
                
                if (chatbotOpen) {
                    const chatInput = document.getElementById('chatInput');
                    if (chatInput) chatInput.focus();
                }
            } catch (error) {
                console.error('Chatbot toggle error:', error);
            }
        }
        
        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }
        
        function sendQuickReply(message) {
            document.getElementById('chatInput').value = message;
            sendChatMessage();
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Get bot response after delay
            setTimeout(() => {
                removeTypingIndicator();
                const response = getChatbotResponse(message);
                addChatMessage(response, 'bot');
            }, 1000 + Math.random() * 500);
        }
        
        function addChatMessage(message, type) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}-message`;
            messageDiv.innerHTML = `
                <div class="message-content">
                    <p>${message}</p>
                </div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message bot-message';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function removeTypingIndicator() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }
        
        function getChatbotResponse(message) {
            const msg = message.toLowerCase();
            const totalExercises = completedExercises.length;
            const avgScore = totalExercises > 0 
                ? Math.round(completedExercises.reduce((sum, ex) => sum + (ex.score || 0), 0) / totalExercises)
                : 0;
            
            // Start session
            if (msg.includes('start') && (msg.includes('session') || msg.includes('therapy'))) {
                return `To start a therapy session:<br><br>
                    1️⃣ Click on <b>"Therapy Session"</b> in the sidebar<br>
                    2️⃣ Click the <b>"Start Session"</b> button<br>
                    3️⃣ Allow microphone and camera access<br>
                    4️⃣ Follow the exercise prompts!<br><br>
                    Would you like me to take you there? Just click the microphone button! 🎤`;
            }
            
            // Progress
            if (msg.includes('progress') || msg.includes('score') || msg.includes('how am i doing')) {
                if (totalExercises === 0) {
                    return `You haven't completed any exercises yet! 📝<br><br>
                        Start your first session to begin tracking your progress. 
                        I'm here to help you improve your speech! 💪`;
                }
                return `Here's your progress summary: 📊<br><br>
                    ✅ <b>Total Exercises:</b> ${totalExercises}<br>
                    📈 <b>Average Score:</b> ${avgScore}%<br>
                    🏆 <b>Best Score:</b> ${Math.max(...completedExercises.map(ex => ex.score || 0))}%<br>
                    🔥 <b>Day Streak:</b> ${document.getElementById('dayStreak')?.textContent || 0} days<br><br>
                    ${avgScore >= 70 ? "Great job! Keep up the excellent work! 🌟" : "Keep practicing! You're making progress! 💪"}`;
            }
            
            // Tips
            if (msg.includes('tip') || msg.includes('advice') || msg.includes('better') || msg.includes('improve')) {
                const tips = [
                    `<b>Speech Improvement Tips:</b> 💡<br><br>
                    🗣️ <b>Slow Down:</b> Speaking slowly helps with clarity<br>
                    🌬️ <b>Breathe:</b> Take deep breaths before speaking<br>
                    👄 <b>Articulate:</b> Exaggerate mouth movements<br>
                    🎯 <b>Practice Daily:</b> 15-20 minutes is ideal<br>
                    🪞 <b>Mirror Practice:</b> Watch yourself speak`,
                    
                    `<b>Quick Tips for Better Speech:</b> ✨<br><br>
                    1. Practice in front of a mirror<br>
                    2. Record yourself and listen back<br>
                    3. Focus on one sound at a time<br>
                    4. Stay hydrated - drink water!<br>
                    5. Don't get discouraged - progress takes time! 🌱`
                ];
                return tips[Math.floor(Math.random() * tips.length)];
            }
            
            // Exercises
            if (msg.includes('exercise') || msg.includes('what should i') || msg.includes('recommend')) {
                return `<b>Recommended Exercises for You:</b> 🎯<br><br>
                    <b>Phonemes (Easy):</b><br>
                    • "AH", "EE", "OO" - Hold for 3 seconds<br><br>
                    <b>Words (Medium):</b><br>
                    • "Hello", "Thank you", "Beautiful"<br><br>
                    <b>Sentences (Hard):</b><br>
                    • "She sells sea shells"<br>
                    • "Peter Piper picked peppers"<br><br>
                    Start with easy exercises and work your way up! 📈`;
            }
            
            // Help
            if (msg.includes('help') || msg.includes('support') || msg.includes('problem') || msg.includes('issue')) {
                return `<b>How can I help?</b> 🤝<br><br>
                    🎤 <b>Microphone issues?</b> Check browser permissions<br>
                    📹 <b>Camera not working?</b> Allow camera access in settings<br>
                    📊 <b>Score questions?</b> Scores are based on clarity & accuracy<br>
                    💾 <b>Save progress?</b> Your progress is automatically saved<br><br>
                    For technical support, visit the Help & Support page!`;
            }
            
            // Greeting
            if (msg.includes('hello') || msg.includes('hi') || msg.includes('hey')) {
                return `Hello! 👋 Nice to chat with you!<br><br>
                    I'm your AMAC Speech Therapy Assistant. I can help you with:<br>
                    • Starting therapy sessions<br>
                    • Checking your progress<br>
                    • Providing speech tips<br>
                    • Recommending exercises<br><br>
                    What would you like to know? 😊`;
            }
            
            // Thank you
            if (msg.includes('thank') || msg.includes('thanks')) {
                return `You're welcome! 😊<br><br>
                    I'm always here to help with your speech therapy journey. 
                    Keep practicing and you'll see great improvements! 🌟`;
            }
            
            // Default response
            return `I'm here to help with your speech therapy! 🎯<br><br>
                Try asking me about:<br>
                • "How do I start a session?"<br>
                • "Show my progress"<br>
                • "Give me tips for better speech"<br>
                • "What exercises should I do?"<br><br>
                Or type any question you have! 💬`;
        }
        
        // ============ MOTIVATIONAL MODAL ============
        const motivationalQuotes = [
            {
                quote: "Every word you speak is a step towards a clearer tomorrow.",
                author: "Speech Therapy Wisdom",
                icon: "🌟"
            },
            {
                quote: "Your voice matters. Keep practicing, keep growing, keep shining!",
                author: "AMAC Therapy",
                icon: "💪"
            },
            {
                quote: "Progress, not perfection. Every attempt makes you stronger.",
                author: "Daily Motivation",
                icon: "🎯"
            },
            {
                quote: "The only way to do great work is to love what you do and never give up.",
                author: "Inspirational",
                icon: "❤️"
            },
            {
                quote: "Small steps every day lead to big changes over time.",
                author: "Growth Mindset",
                icon: "🚀"
            },
            {
                quote: "Believe in yourself. You are capable of amazing things!",
                author: "Self-Belief",
                icon: "✨"
            },
            {
                quote: "Your dedication to improvement inspires everyone around you.",
                author: "Encouragement",
                icon: "🌈"
            },
            {
                quote: "Today is a new opportunity to become a better version of yourself.",
                author: "New Beginnings",
                icon: "🌅"
            },
            {
                quote: "Speech is the mirror of the soul. Let yours shine bright!",
                author: "Publilius Syrus",
                icon: "🪞"
            },
            {
                quote: "With patience and persistence, nothing is impossible.",
                author: "Therapy Success",
                icon: "🏆"
            }
        ];
        
        // Handle click on session status badge
        function handleSessionStatusClick() {
            const status = document.getElementById('sessionStatus').textContent;
            if (status === 'Ready to Start') {
                showMotivationalModal();
            }
        }
        
        function showMotivationalModal() {
            // Get random quote
            const randomQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'motivationalModal';
            modal.innerHTML = `
                <div class="motivation-overlay">
                    <div class="motivation-card">
                        <div class="motivation-icon">${randomQuote.icon}</div>
                        <h2 class="motivation-title">Ready to Begin!</h2>
                        <div class="motivation-quote">
                            <p>"${randomQuote.quote}"</p>
                            <span class="quote-author">— ${randomQuote.author}</span>
                        </div>
                        <div class="motivation-tips">
                            <h4>💡 Quick Tips for Today's Session:</h4>
                            <ul>
                                <li>Take a deep breath before each exercise</li>
                                <li>Speak slowly and clearly</li>
                                <li>Don't worry about mistakes - they help you learn!</li>
                            </ul>
                        </div>
                        <button class="motivation-btn" onclick="closeMotivationalAndStart()">
                            <i class="fas fa-play me-2"></i>Let's Go!
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add animation
            setTimeout(() => {
                modal.querySelector('.motivation-overlay').classList.add('show');
            }, 10);
        }
        
        function closeMotivationalAndStart() {
            const modal = document.getElementById('motivationalModal');
            if (modal) {
                modal.querySelector('.motivation-overlay').classList.remove('show');
                setTimeout(() => {
                    modal.remove();
                    // Now start the actual therapy session
                    startTherapySession();
                }, 300);
            }
        }
    </script>
    
    <!-- Motivational Modal Styles -->
    <style>
        .motivation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .motivation-overlay.show {
            opacity: 1;
        }
        
        .motivation-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            border-radius: 24px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 25px 80px rgba(102, 126, 234, 0.3);
            transform: scale(0.8);
            transition: transform 0.3s ease;
            animation: cardPop 0.4s ease forwards;
        }
        
        @keyframes cardPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .motivation-icon {
            font-size: 60px;
            margin-bottom: 15px;
            animation: bounce 1s ease infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .motivation-title {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
        }
        
        .motivation-quote {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }
        
        .motivation-quote p {
            font-size: 18px;
            font-style: italic;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .quote-author {
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
        }
        
        .motivation-tips {
            text-align: left;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .motivation-tips h4 {
            font-size: 16px;
            color: #333;
            margin-bottom: 12px;
        }
        
        .motivation-tips ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .motivation-tips li {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .motivation-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 50px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .motivation-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
        }
        
        .motivation-btn:active {
            transform: translateY(0);
        }
    </style>
    
    <!-- Floating Action Buttons -->
    <div class="fab-container">
        <button class="fab fab-success" onclick="showPage('progress')" title="View Progress">
            <i class="fas fa-chart-line"></i>
        </button>
        <button class="fab fab-info" onclick="toggleChatbot()" title="Chat Support">
            <i class="fas fa-robot"></i>
        </button>
        <button class="fab fab-primary" onclick="showPage('therapy')" title="Start Therapy">
            <i class="fas fa-microphone-alt"></i>
        </button>
    </div>
    
    <!-- Chatbot Modal -->
    <div id="chatbotModal" class="chatbot-modal" style="display: none;">
        <div class="chatbot-container">
            <div class="chatbot-header">
                <div class="d-flex align-items-center">
                    <div class="chatbot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="mb-0">AMAC Assistant</h5>
                        <small class="text-light opacity-75">Speech Therapy Support</small>
                    </div>
                </div>
                <button class="btn btn-link text-white" onclick="toggleChatbot()">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div class="chatbot-messages" id="chatMessages">
                <div class="chat-message bot-message">
                    <div class="message-content">
                        <p>Hello! 👋 I'm your AMAC Speech Therapy Assistant. How can I help you today?</p>
                        <div class="quick-replies">
                            <button onclick="sendQuickReply('How do I start a session?')">Start a session</button>
                            <button onclick="sendQuickReply('Show my progress')">My progress</button>
                            <button onclick="sendQuickReply('Give me tips for better speech')">Speech tips</button>
                            <button onclick="sendQuickReply('What exercises should I do?')">Exercises</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chatbot-input">
                <input type="text" id="chatInput" placeholder="Type your message..." onkeypress="handleChatKeypress(event)">
                <button onclick="sendChatMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    
    <style>
        /* Chatbot Styles */
        .chatbot-modal {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 1050;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chatbot-container {
            width: 380px;
            max-height: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .chatbot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chatbot-avatar {
            width: 45px;
            height: 45px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-height: 350px;
            background: #f8f9fa;
        }
        
        .chat-message {
            margin-bottom: 15px;
            display: flex;
        }
        
        .bot-message {
            justify-content: flex-start;
        }
        
        .user-message {
            justify-content: flex-end;
        }
        
        .message-content {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .bot-message .message-content {
            background: white;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .user-message .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-content p {
            margin: 0;
        }
        
        .quick-replies {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .quick-replies button {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: #667eea;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-replies button:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }
        
        .chatbot-input {
            padding: 15px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        
        .chatbot-input input {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 25px;
            padding: 10px 18px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .chatbot-input input:focus {
            border-color: #667eea;
        }
        
        .chatbot-input button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .chatbot-input button:hover {
            transform: scale(1.05);
        }
        
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px 15px;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite both;
        }
        
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
    </style>
</body>
</html>